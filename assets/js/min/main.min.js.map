{"version":3,"sources":["main.js"],"names":["VideomailClient","require","DEBUG","VideomailFieldController","Marionette","Object","extend","videomailClient","fieldModel","formModel","initialize","Backbone","Radio","submitChannel","channel","videomailChannel","this","listenTo","registerFieldModel","registerSubmitModel","reply","getSubmitData","validateRequired","hasVideomail","videomailFieldModel","videomailClientLoaded","submitFieldModel","formID","get","submitButtonId","formChannel","loadVideomailClient","maybeSubmit","valid","request","proceed","getExtra","submit","getOption","name","defaultOption","options","siteName","video","limitSeconds","width","countdown","selectors","audio","enabled","callbacks","adjustFormDataBeforePosting","adjustFormDataBeforePostingToVideomailServer","bind","enableAutoValidation","verbose","on","events","PREVIEW","setVideomailKey","GOING_BACK","removeVideomailKey","SUBMITTED","videomailSubmitted","show","key","set","getFormID","videomailKey","getFieldValueByKey","field","getVideomailValue","fieldKey","fieldValue","rawValue","replace","videomail","cb","from","to","subject","body","url","webm","mp4","poster","alias","fieldData","value","onBeforeDestroy","unload","jQuery","document","ready"],"mappings":"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","file":"main.min.js","sourcesContent":["var VideomailClient = require('videomail-client')\r\n\r\n// manual switch to have more stuff printed to console\r\nvar DEBUG = true\r\n\r\n// good documentation on backbone event handling\r\n// http://backbonejs.org/#Events\r\n\r\nvar VideomailFieldController = Marionette.Object.extend({\r\n\r\n    videomailClient:    null,\r\n    fieldModel:         null,\r\n    formModel:          null,\r\n\r\n    initialize: function() {\r\n        Backbone.Radio.DEBUG = DEBUG\r\n\r\n        // TODO do not load anything, nor do any event handling\r\n        // when no fields are of type videomail\r\n        // easy to reproduce: create a default contact form without\r\n        // videomail and it's still loaded ...\r\n        // see https://github.com/wpninjas/ninja-forms-videomail/issues/29\r\n\r\n        var submitChannel    = Backbone.Radio.channel('submit')\r\n        var videomailChannel = Backbone.Radio.channel('videomail')\r\n\r\n        // Backbone Radio Listeners\r\n        // see https://github.com/marionettejs/backbone.radio\r\n\r\n        this.listenTo(\r\n            videomailChannel,\r\n            'init:model',\r\n            this.registerFieldModel\r\n        )\r\n\r\n        this.listenTo(\r\n            submitChannel,\r\n            'init:model',\r\n            this.registerSubmitModel\r\n        )\r\n\r\n        // Radio Responses, see http://developer.ninjaforms.com/codex/field-submission-data/\r\n        videomailChannel.reply('get:submitData',     this.getSubmitData, this)\r\n        videomailChannel.reply('validate:required',  this.validateRequired, this)\r\n\r\n        // needed to validate when submitting\r\n        videomailChannel.reply('validate:modelData', this.hasVideomail, this)\r\n    },\r\n\r\n    // is called every time a ‘videomail’ field is initialized\r\n    // but since we only have one instance per form, it is okay to do it like that for\r\n    // todo add new ninja form configuration to limit instances to 1\r\n    registerFieldModel: function(videomailFieldModel) {\r\n        this.fieldModel = videomailFieldModel\r\n    },\r\n\r\n    videomailClientLoaded: function() {\r\n        return !!this.videomailClient\r\n    },\r\n\r\n    // called when submit button has been laid out internally\r\n    registerSubmitModel: function(submitFieldModel) {\r\n\r\n        // precaution: proceed only when not initialised yet otherwise\r\n        // videomail client is loaded again after submission.\r\n        //\r\n        // can also be prevented in a form setting in the Advanced domain\r\n        // of the form builder, under Display Settings,\r\n        // that allows you to clear/hide the form after submission\r\n        if (!this.videomailClientLoaded()) {\r\n\r\n            var formID         = \"form-\" + submitFieldModel.get('formID')\r\n            var submitButtonId = \"nf-field-\" + submitFieldModel.get('id')\r\n            var formChannel    = Backbone.Radio.channel(formID)\r\n\r\n            this.loadVideomailClient({submitButtonId: submitButtonId})\r\n\r\n            formChannel.reply(\r\n                'maybe:submit',\r\n                this.maybeSubmit,\r\n                this,\r\n                formID\r\n            )\r\n        }\r\n    },\r\n\r\n    validateRequired: function() {\r\n        var valid = this.hasVideomail()\r\n\r\n        // override default behaviour so that we can set our own error text here\r\n        if (!valid) {\r\n            Backbone.Radio.channel('fields').request(\r\n                'add:error',\r\n                this.fieldModel.get('id'),\r\n                'required-error',\r\n                \"Record and click on stop to see a preview video.\"\r\n            )\r\n        }\r\n\r\n        return valid\r\n    },\r\n\r\n    // called when about to start a submission\r\n    // how to stop a submission? see:\r\n    // http://developer.ninjaforms.com/codex/startstop-submission/\r\n    maybeSubmit: function(formModel) {\r\n        // halt the normal ninja form submission by default\r\n        var proceed = false\r\n\r\n        // remember form model for some submission-related functions further below\r\n        this.formModel = formModel\r\n\r\n        if (this.formModel.getExtra('videomail_submitted')) {\r\n            // yes, videomail is on the videomail server, so\r\n            // proceed with the normal ninja form submission routine\r\n            proceed = true\r\n        } else {\r\n            // manually trigger the whole videomail submission\r\n            // we cant be using the submit button click event since it's too\r\n            // deep wrapped within backbone containers :(\r\n            this.videomailClient.submit()\r\n        }\r\n\r\n        return proceed\r\n    },\r\n\r\n    getOption: function(name, defaultOption) {\r\n        // todo the this.fieldModel check is temporary until\r\n        // https://github.com/wpninjas/ninja-forms-videomail/issues/29 is resolved\r\n        return this.fieldModel && this.fieldModel.get(name) || defaultOption\r\n    },\r\n\r\n    loadVideomailClient: function(options) {\r\n        this.videomailClient = new VideomailClient({\r\n            siteName: this.getOption('site_name'),\r\n            video: {\r\n                limitSeconds:   this.getOption('limit_seconds', 80),\r\n                width:          this.getOption('width', 320),\r\n                countdown:      this.getOption('countdown', false)\r\n            },\r\n            selectors: {\r\n                submitButtonId: options.submitButtonId\r\n            },\r\n            audio: {\r\n                enabled: this.getOption('audio_enabled', false)\r\n            },\r\n            callbacks: {\r\n                adjustFormDataBeforePosting:\r\n                // ugly name eh?\r\n                this.adjustFormDataBeforePostingToVideomailServer.bind(this)\r\n            },\r\n            // leave it to ninja form to validate the inputs\r\n            enableAutoValidation: false,\r\n            // log actions/events to console\r\n            verbose: this.getOption('verbose', DEBUG)\r\n        })\r\n\r\n        // needed to get the videomail key which is required before submission\r\n        this.videomailClient.on(\r\n            this.videomailClient.events.PREVIEW,\r\n            this.setVideomailKey.bind(this)\r\n        )\r\n\r\n        // needed to invalidate form\r\n        this.videomailClient.on(\r\n            this.videomailClient.events.GOING_BACK,\r\n            this.removeVideomailKey.bind(this)\r\n        )\r\n\r\n        this.videomailClient.on(\r\n            this.videomailClient.events.SUBMITTED,\r\n            this.videomailSubmitted.bind(this)\r\n        )\r\n\r\n        this.videomailClient.show()\r\n    },\r\n\r\n    setVideomailKey: function(key) {\r\n        this.fieldModel.set('videomail-key', key)\r\n\r\n        Backbone.Radio.channel('fields').request(\r\n            'remove:error',\r\n            this.fieldModel.get('id'),\r\n            'required-error'\r\n        )\r\n    },\r\n\r\n    removeVideomailKey: function() {\r\n        this.setVideomailKey(null)\r\n    },\r\n\r\n    getFormID: function() {\r\n        return 'form-' + this.formModel.get('id')\r\n    },\r\n\r\n    hasVideomail: function() {\r\n        var videomailKey = this.fieldModel.get('videomail-key')\r\n\r\n        return !!videomailKey\r\n    },\r\n\r\n    getFieldValueByKey: function(key) {\r\n        var field =\r\n            Backbone.Radio.channel(this.getFormID())\r\n                .request('get:fieldByKey', key)\r\n\r\n        if (field) {\r\n            return field.get('value')\r\n        } else {\r\n            // must have been a bad config from the user - in that case just do nothing\r\n            return null\r\n        }\r\n    },\r\n\r\n    getVideomailValue: function(fieldKey) {\r\n        var fieldValue = this.fieldModel.get(fieldKey)\r\n        var rawValue   = null\r\n\r\n        // it can happen that the user has configured something wrong,\r\n        // i.E. an empty email_from. in that case just ignore ...\r\n        if (fieldValue) {\r\n            // extract the key from the merge tag.\r\n            // todo: make it work for i.E. {system:admin_email} as well, see\r\n            // https://github.com/wpninjas/ninja-forms-videomail/issues/30\r\n            rawValue = fieldValue.replace('{field:', '').replace('}', '')\r\n\r\n            if (rawValue != fieldValue) {\r\n                // yes it was a merge tag, so resolve it again\r\n                rawValue = this.getFieldValueByKey(rawValue)\r\n            }\r\n        }\r\n\r\n        return rawValue\r\n    },\r\n\r\n    adjustFormDataBeforePostingToVideomailServer: function(videomail, cb) {\r\n        videomail.from    = this.getVideomailValue('email_from')\r\n        videomail.to      = this.getVideomailValue('email_to')\r\n        videomail.subject = this.getVideomailValue('email_subject')\r\n        videomail.body    = this.getVideomailValue('email_body')\r\n\r\n        cb(null, videomail)\r\n    },\r\n\r\n    videomailSubmitted: function(videomail) {\r\n        // pass on some videomail attributes to the field model\r\n        this.fieldModel.set('value', videomail.url)\r\n        this.fieldModel.set('videomail-url', videomail.url)\r\n        this.fieldModel.set('videomail-webm', videomail.webm)\r\n        this.fieldModel.set('videomail-mp4', videomail.mp4)\r\n        this.fieldModel.set('videomail-poster', videomail.poster)\r\n        this.fieldModel.set('videomail-alias', videomail.alias)\r\n        this.fieldModel.set('videomail-key', videomail.key)\r\n\r\n        var formID = this.getFormID()\r\n\r\n        // set re-videomail_submitted flag so that we can continue\r\n        // with the normal ninja form submission\r\n        Backbone.Radio.channel(formID).request('add:extra', 'videomail_submitted', true)\r\n\r\n        // re-start submission\r\n        Backbone.Radio.channel(formID).request('submit', this.formModel)\r\n    },\r\n\r\n    getSubmitData: function(fieldData, fieldModel) {\r\n        fieldData.key       = fieldModel.get('videomail-key')\r\n        fieldData.value     = fieldModel.get('videomail-url')\r\n        fieldData.url       = fieldModel.get('videomail-url')\r\n        fieldData.webm      = fieldModel.get('videomail-webm')\r\n        fieldData.mp4       = fieldModel.get('videomail-mp4')\r\n        fieldData.poster    = fieldModel.get('videomail-poster')\r\n        fieldData.alias     = fieldModel.get('videomail-alias')\r\n\r\n        return fieldData\r\n    },\r\n\r\n    onBeforeDestroy: function() {\r\n        this.videomailClient.unload()\r\n    }\r\n})\r\n\r\njQuery(document).ready(function() {\r\n    new VideomailFieldController()\r\n})\r\n"]}