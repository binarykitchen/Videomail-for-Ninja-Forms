{"version":3,"sources":["main.js"],"names":["VideomailClient","require","DEBUG","VideomailFieldController","Marionette","Object","extend","videomailClient","initialize","Backbone","Radio","this","listenTo","channel","registerVideomailField","fieldModel","formID","get","loadVideomailClient","reply","validateRequired","validateVideomail","maybeSubmit","getSubmitData","siteName","video","limitSeconds","width","countdown","audio","enabled","enableAutoValidation","verbose","on","events","PREVIEW","key","console","log","set","GOING_BACK","SUBMITTED","videomail","show","valid","hasVideomail","request","formModel","getExtra","submit","fieldData","value","url","webm","mp4","poster","alias","onBeforeDestroy","unload","jQuery","document","ready"],"mappings":"AAAA,GAAIA,iBAAkBC,QAAQ,oBAG1BC,OAAQ,EAKRC,yBAA2BC,WAAWC,OAAOC,QAE7CC,gBAAoB,KAEpBC,WAAY,WACRC,SAASC,MAAMR,MAAQA,MAEvBS,KAAKC,SAAUH,SAASC,MAAMG,QAAS,aAAe,aAAcF,KAAKG,yBAG7EA,uBAAwB,SAAUC,GAE9B,GAAIC,GAASD,EAAWE,IAAK,SAE7BN,MAAKO,oBAAqBH,GAE1BN,SAASC,MAAMG,QAAS,aAAmBM,MAAO,oBAAsBR,KAAKS,iBAAmBT,MAChGF,SAASC,MAAMG,QAAS,aAAmBM,MAAO,qBAAsBR,KAAKU,kBAAmBV,MAChGF,SAASC,MAAMG,QAAS,QAAUG,GAASG,MAAO,eAAsBR,KAAKW,YAAmBX,KAAMI,GACtGN,SAASC,MAAMG,QAAS,aAAmBM,MAAO,iBAAsBR,KAAKY,cAAmBZ,OAGpGO,oBAAqB,SAAUH,GAC3BJ,KAAKJ,gBAAkB,GAAIP,kBACvBwB,SAAUT,EAAWE,IAAK,aAC1BQ,OACIC,aAAgBX,EAAWE,IAAK,kBAAqB,GACrDU,MAAgBZ,EAAWE,IAAK,UAAa,IAC7CW,UAAgBb,EAAWE,IAAK,eAAiB,GAErDY,OACIC,QAASf,EAAWE,IAAK,mBAAqB,GAQlDc,sBAAsB,EAEtBC,QAASjB,EAAWE,IAAK,YAAef,QAI5CS,KAAKJ,gBAAgB0B,GAAItB,KAAKJ,gBAAgB2B,OAAOC,QAAS,SAAUC,GACpEC,QAAQC,IAAK,sBACbD,QAAQC,IAAKF,GACbrB,EAAWwB,IAAK,gBAAiBH,KAIrCzB,KAAKJ,gBAAgB0B,GAAItB,KAAKJ,gBAAgB2B,OAAOM,WAAW,WAC5DH,QAAQC,IAAK,2BAGjB3B,KAAKJ,gBAAgB0B,GAAItB,KAAKJ,gBAAgB2B,OAAOO,UAAW,SAAUC,GACtEL,QAAQC,IAAK,wBACbD,QAAQC,IAAKI,KAGjB/B,KAAKJ,gBAAgBoC,QAGzBvB,iBAAkB,WACd,GAAIwB,GAAQjC,KAAKkC,cAYjB,OATKD,IACDnC,SAASC,MAAMG,QAAQ,UAAUiC,QAC7B,YACAnC,KAAKI,WAAWE,IAAI,MACpB,iBACA,oDAID2B,GAGXvB,kBAAmB,SAAUN,GACzB,MAAOA,GAAWE,IAAI,mBAAoB,GAG9CK,YAAa,SAASyB,GAElB,MADAV,SAAQC,IAAKS,EAAUC,SAAU,0BAC1BD,EAAUC,SAAU,yBACvBrC,KAAKJ,gBAAgB0C,UACd,IAKf1B,cAAe,SAAS2B,EAAWnC,GAS/B,MARAmC,GAAUd,IAAYrB,EAAWE,IAAI,iBACrCiC,EAAUC,MAAYpC,EAAWE,IAAI,iBACrCiC,EAAUE,IAAYrC,EAAWE,IAAI,iBACrCiC,EAAUG,KAAYtC,EAAWE,IAAI,kBACrCiC,EAAUI,IAAYvC,EAAWE,IAAI,iBACrCiC,EAAUK,OAAYxC,EAAWE,IAAI,oBACrCiC,EAAUM,MAAYzC,EAAWE,IAAI,mBAE9BiC,GAuBXO,gBAAiB,WACb9C,KAAKJ,gBAAgBmD,WAI7BC,QAAOC,UAAUC,MAAM,WACnB,GAAI1D","file":"main.min.js","sourcesContent":["var VideomailClient = require('videomail-client')\r\n\r\n// manual switch to have more stuff printed to console\r\nvar DEBUG = true\r\n\r\n// good documentation on backbone event handling\r\n// http://backbonejs.org/#Events\r\n\r\nvar VideomailFieldController = Marionette.Object.extend({\r\n\r\n    videomailClient:    null,\r\n\r\n    initialize: function() {\r\n        Backbone.Radio.DEBUG = DEBUG;\r\n\r\n        this.listenTo( Backbone.Radio.channel( 'videomail' ), 'init:model', this.registerVideomailField );\r\n    },\r\n\r\n    registerVideomailField: function( fieldModel ){\r\n\r\n        var formID = fieldModel.get( 'formID' );\r\n\r\n        this.loadVideomailClient( fieldModel );\r\n\r\n        Backbone.Radio.channel( 'videomail'      ).reply( 'validate:required',  this.validateRequired,  this             );\r\n        Backbone.Radio.channel( 'videomail'      ).reply( 'validate:modelData', this.validateVideomail, this             );\r\n        Backbone.Radio.channel( 'form-' + formID ).reply( 'maybe:submit',       this.maybeSubmit,       this, fieldModel );\r\n        Backbone.Radio.channel( 'videomail'      ).reply( 'get:submitData',     this.getSubmitData,     this             );\r\n    },\r\n\r\n    loadVideomailClient: function( fieldModel ) {\r\n        this.videomailClient = new VideomailClient({\r\n            siteName: fieldModel.get( 'site_name' ),\r\n            video: {\r\n                limitSeconds:   fieldModel.get( 'limit_seconds' ) || 80,\r\n                width:          fieldModel.get( 'width' ) || 320,\r\n                countdown:      fieldModel.get( 'countdown' ) || false,\r\n            },\r\n            audio: {\r\n                enabled: fieldModel.get( 'audio_enabled' ) || false,\r\n            },\r\n            // callbacks: {\r\n            //     adjustFormDataBeforePosting:\r\n            //     // ugly name eh?\r\n            //     this.adjustFormDataBeforePostingToVideomailServer.bind(this)\r\n            // },\r\n            // leave it to ninja form to validate the inputs\r\n            enableAutoValidation: false,\r\n            // log actions/events to console\r\n            verbose: fieldModel.get( 'verbose' ) || DEBUG\r\n        })\r\n\r\n        // needed to get the videomail key which is required before submission\r\n        this.videomailClient.on( this.videomailClient.events.PREVIEW, function( key ){\r\n            console.log( 'VIDEOMAIL: PREVIEW' );\r\n            console.log( key );\r\n            fieldModel.set( 'videomail-key', key );\r\n        });\r\n\r\n        // needed to invalidate form\r\n        this.videomailClient.on( this.videomailClient.events.GOING_BACK,function(){\r\n            console.log( 'VIDEOMAIL: GOING BACK' );\r\n        });\r\n\r\n        this.videomailClient.on( this.videomailClient.events.SUBMITTED, function( videomail ){\r\n            console.log( 'VIDEOMAIL: SUBMITTED' );\r\n            console.log( videomail );\r\n        });\r\n\r\n        this.videomailClient.show()\r\n    },\r\n\r\n    validateRequired: function() {\r\n        var valid = this.hasVideomail()\r\n\r\n        // override default behaviour so that we can set our own error text here\r\n        if (!valid) {\r\n            Backbone.Radio.channel('fields').request(\r\n                'add:error',\r\n                this.fieldModel.get('id'),\r\n                'required-error',\r\n                \"Record and click on stop to see a preview video.\"\r\n            )\r\n        }\r\n\r\n        return valid\r\n    },\r\n\r\n    validateVideomail: function( fieldModel ) {\r\n        return fieldModel.get('videomail-key') || false;\r\n    },\r\n\r\n    maybeSubmit: function(formModel) {\r\n        console.log( formModel.getExtra( 'videomail_submitted' ) );\r\n        if ( ! formModel.getExtra( 'videomail_submitted' ) ) {\r\n            this.videomailClient.submit();\r\n            return false;\r\n        }\r\n        return true;\r\n    },\r\n\r\n    getSubmitData: function(fieldData, fieldModel) {\r\n        fieldData.key       = fieldModel.get('videomail-key')\r\n        fieldData.value     = fieldModel.get('videomail-url')\r\n        fieldData.url       = fieldModel.get('videomail-url')\r\n        fieldData.webm      = fieldModel.get('videomail-webm')\r\n        fieldData.mp4       = fieldModel.get('videomail-mp4')\r\n        fieldData.poster    = fieldModel.get('videomail-poster')\r\n        fieldData.alias     = fieldModel.get('videomail-alias')\r\n\r\n        return fieldData\r\n    },\r\n\r\n    // videomailSubmitted: function(videomail) {\r\n    //     // pass on some videomail attributes to the field model\r\n    //     this.fieldModel.set('value', videomail.url)\r\n    //     this.fieldModel.set('videomail-url', videomail.url)\r\n    //     this.fieldModel.set('videomail-webm', videomail.webm)\r\n    //     this.fieldModel.set('videomail-mp4', videomail.mp4)\r\n    //     this.fieldModel.set('videomail-poster', videomail.poster)\r\n    //     this.fieldModel.set('videomail-alias', videomail.alias)\r\n    //     this.fieldModel.set('videomail-key', videomail.key)\r\n    //\r\n    //     var formID = this.getFormID()\r\n    //\r\n    //     // set re-videomail_submitted flag so that we can continue\r\n    //     // with the normal ninja form submission\r\n    //     Backbone.Radio.channel(formID).request('add:extra', 'videomail_submitted', true)\r\n    //\r\n    //     // re-start submission\r\n    //     Backbone.Radio.channel(formID).request('submit', this.formModel)\r\n    // },\r\n\r\n    onBeforeDestroy: function() {\r\n        this.videomailClient.unload()\r\n    }\r\n});\r\n\r\njQuery(document).ready(function() {\r\n    new VideomailFieldController();\r\n});\r\n"]}