var VideomailClient=require("videomail-client"),DEBUG=!1,VideomailFieldController=Marionette.Object.extend({submitButtonId:null,videomailClient:null,fieldModel:null,initialize:function(){Backbone.Radio.DEBUG=DEBUG;var e=Backbone.Radio.channel("submit"),i=Backbone.Radio.channel("videomail");this.listenTo(e,"init:model",this.registerSubmitModel),this.listenTo(i,"init:model",this.registerFieldModel),i.reply("get:submitData",this.getSubmitData,this),i.reply("validate:modelData",this.validateModelData,this),i.reply("validate:required",this.validateRequired,this)},registerFieldModel:function(e){this.fieldModel=e},registerSubmitModel:function(e){if(this.fieldModel){var i="form-"+e.get("formID");Backbone.Radio.channel(i).reply("maybe:submit",this.beforeSubmit,this,i),this.loadVideomailClient(e)}else console.error("Videomail field has not been initialized.")},beforeSubmit:function(e){var i=nfRadio.channel("app").request("get:form",e);return!!i.getExtra("processed")||(this.otherProcessing(i),!1)},otherProcessing:function(e){var i="form-"+e.get("id");nfRadio.channel(i).request("add:extra","processed",!0),nfRadio.channel(i).request("submit",e)},getOption:function(e,i){return this.fieldModel.get(e)||i},loadVideomailClient:function(e){var i="nf-field-"+e.get("id");this.videomailClient=new VideomailClient({siteName:this.getOption("site_name"),video:{limitSeconds:this.getOption("limit_seconds",80),width:this.getOption("width",320),countdown:this.getOption("countdown",!1)},selectors:{submitButtonId:i},audio:{enabled:this.getOption("audio_enabled",!1)},callbacks:{adjustFormDataBeforePosting:this.adjustFormDataBeforePosting.bind(this)},defaults:{to:null},verbose:this.getOption("verbose",DEBUG)}),this.videomailClient.on(this.videomailClient.events.PREVIEW,this.setVideomailKey.bind(this)),this.videomailClient.show()},setVideomailKey:function(e){this.fieldModel.set("videomail-key",e)},validateModelData:function(){var e=this.fieldModel.get("videomail-key");return!!e},getVideomailFieldName:function(e){return this.fieldModel.get(e)},adjustFormDataBeforePosting:function(e,i){this.getVideomailFieldName("email_from"),this.getVideomailFieldName("email_to"),this.getVideomailFieldName("email_subject"),this.getVideomailFieldName("email_body");i(null,e)},validateRequired:function(){return!0},getSubmitData:function(e,i){return e.value=i.get("videomail-key"),e.key=i.get("videomail-key"),e.url=i.get("videomail-url"),e.webm=i.get("videomail-webm"),e.mp4=i.get("videomail-mp4"),e.poster=i.get("videomail-poster"),e.alias=i.get("videomail-alias"),e},onBeforeDestroy:function(){this.videomailClient.unload()}});jQuery(document).ready(function(){new VideomailFieldController});