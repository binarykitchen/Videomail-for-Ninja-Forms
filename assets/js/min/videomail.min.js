var VideomailClient=require("videomail-client"),DEBUG=!1,VideomailFieldController=Marionette.Object.extend({submitButtonId:null,videomailClient:null,fieldModel:null,formModel:null,initialize:function(){Backbone.Radio.DEBUG=DEBUG;var e=Backbone.Radio.channel("submit"),i=Backbone.Radio.channel("videomail");this.listenTo(e,"init:model",this.registerSubmitModel),this.listenTo(i,"init:model",this.registerFieldModel),i.reply("get:submitData",this.getSubmitData,this),i.reply("validate:modelData",this.validateModelData,this),i.reply("validate:required",this.validateRequired,this)},registerFieldModel:function(e){this.fieldModel=e},registerSubmitModel:function(e){if(this.fieldModel){if(this.videomailClient)return;var i="form-"+e.get("formID");this.submitButtonId="nf-field-"+e.get("id"),Backbone.Radio.channel(i).reply("maybe:submit",this.beforeSubmit,this,i),this.loadVideomailClient()}else console.error("Videomail field has not been initialized.")},validateRequired:function(){return!0},beforeSubmit:function(e){return this.formModel=Backbone.Radio.channel("app").request("get:form",e),!!this.formModel.getExtra("videomail_submitted")||(document.getElementById(this.submitButtonId).click(),!1)},getOption:function(e,i){return this.fieldModel.get(e)||i},loadVideomailClient:function(){this.videomailClient=new VideomailClient({siteName:this.getOption("site_name"),video:{limitSeconds:this.getOption("limit_seconds",80),width:this.getOption("width",320),countdown:this.getOption("countdown",!1)},selectors:{submitButtonId:this.submitButtonId},audio:{enabled:this.getOption("audio_enabled",!1)},callbacks:{adjustFormDataBeforePosting:this.adjustFormDataBeforePostingToVideomailServer.bind(this)},defaults:{to:null},verbose:this.getOption("verbose",DEBUG)}),this.videomailClient.on(this.videomailClient.events.PREVIEW,this.setVideomailKey.bind(this)),this.videomailClient.on(this.videomailClient.events.SUBMITTED,this.videomailSubmitted.bind(this)),this.videomailClient.show()},setVideomailKey:function(e){this.fieldModel.set("videomail-key",e)},getFormID:function(){return"form-"+this.formModel.get("id")},validateModelData:function(){var e=this.fieldModel.get("videomail-key");return!!e},getFieldValueByKey:function(e){var i=Backbone.Radio.channel(this.getFormID()).request("get:fieldByKey",e);return i.get("value")},getVideomailValue:function(e){var i=this.fieldModel.get(e),t=i.replace("{field:","").replace("}","");return t!=i&&(t=this.getFieldValueByKey(t)),t},adjustFormDataBeforePostingToVideomailServer:function(e,i){e.from=this.getVideomailValue("email_from"),e.to=this.getVideomailValue("email_to"),e.subject=this.getVideomailValue("email_subject"),e.body=this.getVideomailValue("email_body"),i(null,e)},videomailSubmitted:function(e){this.fieldModel.set("value",e.url),this.fieldModel.set("videomail-url",e.url),this.fieldModel.set("videomail-webm",e.webm),this.fieldModel.set("videomail-mp4",e.mp4),this.fieldModel.set("videomail-poster",e.poster),this.fieldModel.set("videomail-alias",e.alias),this.fieldModel.set("videomail-key",e.key);var i=this.getFormID();nfRadio.channel(i).request("add:extra","videomail_submitted",!0),nfRadio.channel(i).request("submit",this.formModel)},getSubmitData:function(e,i){return e.key=i.get("videomail-key"),e.value=i.get("videomail-url"),e.url=i.get("videomail-url"),e.webm=i.get("videomail-webm"),e.mp4=i.get("videomail-mp4"),e.poster=i.get("videomail-poster"),e.alias=i.get("videomail-alias"),e},onBeforeDestroy:function(){this.videomailClient.unload()}});jQuery(document).ready(function(){new VideomailFieldController});