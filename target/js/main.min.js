var DEBUG=!1,VideomailFieldController=Marionette.Object.extend({videomailClient:null,fieldModel:null,initialize:function(){Backbone.Radio.DEBUG=DEBUG,this.listenTo(Backbone.Radio.channel("videomail"),"init:model",this.registerVideomailField)},getFormId:function(){return this.fieldModel.get("formID")},registerVideomailField:function(e){this.videomailClient||(this.fieldModel=e,this.loadVideomailClient(),Backbone.Radio.channel("videomail").reply("validate:required",this.validateRequired,this),Backbone.Radio.channel("videomail").reply("validate:modelData",this.validateVideomail,this),Backbone.Radio.channel("form-"+this.getFormId()).reply("maybe:submit",this.maybeSubmit,this,e))},loadVideomailClient:function(){var e=this.fieldModel.get("image_quality")||40;e>100?e=100:e<1&&(e=1),this.videomailClient=new VideomailClient({siteName:this.fieldModel.get("site_name"),video:{limitSeconds:this.fieldModel.get("limit_seconds")||90,width:this.fieldModel.get("width")||320,countdown:this.fieldModel.get("countdown")||!1},audio:{enabled:this.fieldModel.get("audio_enabled")||!1},image:{quality:e/100},selectors:{submitButtonSelector:".submit-wrap input"},callbacks:{adjustFormDataBeforePosting:this.adjustFormDataBeforePostingToVideomailServer.bind(this)},enableAutoValidation:!1,enableAutoSubmission:!1,verbose:this.fieldModel.get("verbose")||DEBUG}),this.videomailClient.on(this.videomailClient.events.PREVIEW,this.onPreview.bind(this)),this.videomailClient.on(this.videomailClient.events.SUBMITTED,this.onSubmitted.bind(this)),this.videomailClient.on(this.videomailClient.events.GOING_BACK,this.onGoingBack.bind(this)),this.videomailClient.show()},onPreview:function(e){this.fieldModel.set("videomail-key",e),Backbone.Radio.channel("fields").request("remove:error",this.fieldModel.get("id"),"required-error")},onSubmitted:function(e){var i=nfRadio.channel("app").request("get:form",this.getFormId());nfRadio.channel("form-"+i.get("id")).request("add:extra","videomail",e),nfRadio.channel("form-"+this.getFormId()).request("submit",i)},onGoingBack:function(){this.fieldModel.set("videomail-key",null),this.invalidate()},validateRequired:function(e,i){var t=this.validateVideomail(i);return t||this.invalidate(),t},invalidate:function(){Backbone.Radio.channel("fields").request("add:error",this.fieldModel.get("id"),"required-error","Record and click on stop to see a preview video.")},validateVideomail:function(e){return(e=e||this.fieldModel).get("videomail-key")||!1},hasErrors:function(e){return e.get("errors").length>0},maybeSubmit:function(e){var i=!0,t=e.getExtra("videomail"),o=this.validateVideomail(),l=this.hasErrors(e);return t||l||!o||(this.videomailClient.submit(),i=!1),i},getMergeTagValue:function(e,i){var t=this.fieldModel.get(e);if(t)if("{wp:admin_email}"===t)t=window.nfVideomail.admin_email;else{var o=t.replace("{field:","").replace("}","");o!==t&&(t=i[o])}return t},getFormValues:function(){return Backbone.Radio.channel("app").request("get:form",this.getFormId()).get("fields").reduce(function(e,i){return e[i.get("key")]=i.get("value"),e},{})},adjustFormDataBeforePostingToVideomailServer:function(e,i){var t=this.getFormValues();e.from=this.getMergeTagValue("email_from",t),e.to=this.getMergeTagValue("email_to",t),e.subject=this.getMergeTagValue("email_subject",t),e.body=this.getMergeTagValue("email_body",t),i(null,e)},onBeforeDestroy:function(){this.videomailClient.unload(),delete this.videomailClient}});jQuery(document).ready(function(){return new VideomailFieldController});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsiREVCVUciLCJWaWRlb21haWxGaWVsZENvbnRyb2xsZXIiLCJNYXJpb25ldHRlIiwiT2JqZWN0IiwiZXh0ZW5kIiwidmlkZW9tYWlsQ2xpZW50IiwiZmllbGRNb2RlbCIsImluaXRpYWxpemUiLCJCYWNrYm9uZSIsIlJhZGlvIiwidGhpcyIsImxpc3RlblRvIiwiY2hhbm5lbCIsInJlZ2lzdGVyVmlkZW9tYWlsRmllbGQiLCJnZXRGb3JtSWQiLCJnZXQiLCJsb2FkVmlkZW9tYWlsQ2xpZW50IiwicmVwbHkiLCJ2YWxpZGF0ZVJlcXVpcmVkIiwidmFsaWRhdGVWaWRlb21haWwiLCJtYXliZVN1Ym1pdCIsImltYWdlUXVhbGl0eVBlcmNlbnRhZ2UiLCJWaWRlb21haWxDbGllbnQiLCJzaXRlTmFtZSIsInZpZGVvIiwibGltaXRTZWNvbmRzIiwid2lkdGgiLCJjb3VudGRvd24iLCJhdWRpbyIsImVuYWJsZWQiLCJpbWFnZSIsInF1YWxpdHkiLCJzZWxlY3RvcnMiLCJzdWJtaXRCdXR0b25TZWxlY3RvciIsImNhbGxiYWNrcyIsImFkanVzdEZvcm1EYXRhQmVmb3JlUG9zdGluZyIsImFkanVzdEZvcm1EYXRhQmVmb3JlUG9zdGluZ1RvVmlkZW9tYWlsU2VydmVyIiwiYmluZCIsImVuYWJsZUF1dG9WYWxpZGF0aW9uIiwiZW5hYmxlQXV0b1N1Ym1pc3Npb24iLCJ2ZXJib3NlIiwib24iLCJldmVudHMiLCJQUkVWSUVXIiwib25QcmV2aWV3IiwiU1VCTUlUVEVEIiwib25TdWJtaXR0ZWQiLCJHT0lOR19CQUNLIiwib25Hb2luZ0JhY2siLCJzaG93Iiwia2V5Iiwic2V0IiwicmVxdWVzdCIsInZpZGVvbWFpbCIsImZvcm1Nb2RlbCIsIm5mUmFkaW8iLCJpbnZhbGlkYXRlIiwiZWwiLCJ2YWxpZCIsImhhc0Vycm9ycyIsImxlbmd0aCIsIm1heWJlIiwidmlkZW9tYWlsU3VibWl0dGVkIiwiZ2V0RXh0cmEiLCJ2aWRlb21haWxSZWNvcmRlZCIsImVycm9ybmVvdXMiLCJzdWJtaXQiLCJnZXRNZXJnZVRhZ1ZhbHVlIiwiZmllbGRLZXkiLCJmb3JtVmFsdWVzIiwidmFsdWUiLCJ3aW5kb3ciLCJuZlZpZGVvbWFpbCIsImFkbWluX2VtYWlsIiwicmF3RmllbGRLZXkiLCJyZXBsYWNlIiwiZ2V0Rm9ybVZhbHVlcyIsInJlZHVjZSIsIm1lbW8iLCJmaWVsZCIsImNiIiwiZnJvbSIsInRvIiwic3ViamVjdCIsImJvZHkiLCJvbkJlZm9yZURlc3Ryb3kiLCJ1bmxvYWQiLCJqUXVlcnkiLCJkb2N1bWVudCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiQUFDQSxJQUFJQSxPQUFRLEVBS1JDLHlCQUEyQkMsV0FBV0MsT0FBT0MsUUFFL0NDLGdCQUFpQixLQUdqQkMsV0FBWSxLQUVaQyxXQUFZLFdBQ1ZDLFNBQVNDLE1BQU1ULE1BQVFBLE1BRXZCVSxLQUFLQyxTQUNISCxTQUFTQyxNQUFNRyxRQUFRLGFBQ3ZCLGFBQ0FGLEtBQUtHLHlCQUlUQyxVQUFXLFdBQ1QsT0FBT0osS0FBS0osV0FBV1MsSUFBSSxXQUc3QkYsdUJBQXdCLFNBQVVQLEdBRzNCSSxLQUFLTCxrQkFDUkssS0FBS0osV0FBYUEsRUFFbEJJLEtBQUtNLHNCQUlMUixTQUFTQyxNQUFNRyxRQUFRLGFBQWFLLE1BQ2xDLG9CQUNBUCxLQUFLUSxpQkFDTFIsTUFHRkYsU0FBU0MsTUFBTUcsUUFBUSxhQUFhSyxNQUNsQyxxQkFDQVAsS0FBS1Msa0JBQ0xULE1BS0ZGLFNBQVNDLE1BQU1HLFFBQVEsUUFBVUYsS0FBS0ksYUFBYUcsTUFDakQsZUFDQVAsS0FBS1UsWUFDTFYsS0FDQUosS0FLTlUsb0JBQXFCLFdBQ25CLElBQUlLLEVBQXlCWCxLQUFLSixXQUFXUyxJQUFJLGtCQUFvQixHQUVqRU0sRUFBeUIsSUFDM0JBLEVBQXlCLElBQ2hCQSxFQUF5QixJQUNsQ0EsRUFBeUIsR0FHM0JYLEtBQUtMLGdCQUFrQixJQUFJaUIsaUJBQ3pCQyxTQUFVYixLQUFLSixXQUFXUyxJQUFJLGFBQzlCUyxP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LEVBQVcyQixHQUNqRSxJQUFJWCxFQUFhM0QsS0FBS2tFLGdCQUV0QnZCLEVBQVU0QixLQUFPdkUsS0FBS3lELGlCQUFpQixhQUFjRSxHQUNyRGhCLEVBQVU2QixHQUFLeEUsS0FBS3lELGlCQUFpQixXQUFZRSxHQUNqRGhCLEVBQVU4QixRQUFVekUsS0FBS3lELGlCQUFpQixnQkFBaUJFLEdBQzNEaEIsRUFBVStCLEtBQU8xRSxLQUFLeUQsaUJBQWlCLGFBQWNFLEdBRXJEVyxFQUFHLEtBQU0zQixJQUdYZ0MsZ0JBQWlCLFdBQ2YzRSxLQUFLTCxnQkFBZ0JpRixnQkFDZDVFLEtBQUtMLG1CQUloQmtGLE9BQU9DLFVBQVVDLE1BQU0sV0FDckIsT0FBTyxJQUFJeEYiLCJmaWxlIjoibWFpbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBtYW51YWwgc3dpdGNoIHRvIGhhdmUgbW9yZSBzdHVmZiBwcmludGVkIHRvIGNvbnNvbGVcbnZhciBERUJVRyA9IGZhbHNlXG5cbi8vIGdvb2QgZG9jdW1lbnRhdGlvbiBvbiBiYWNrYm9uZSBldmVudCBoYW5kbGluZ1xuLy8gaHR0cDovL2JhY2tib25lanMub3JnLyNFdmVudHNcblxudmFyIFZpZGVvbWFpbEZpZWxkQ29udHJvbGxlciA9IE1hcmlvbmV0dGUuT2JqZWN0LmV4dGVuZCh7XG5cbiAgdmlkZW9tYWlsQ2xpZW50OiBudWxsLFxuXG4gIC8vIG5vdCBzdXJlIGlmIHRoaXMgaXMgYSBnb29kIGlkZWEsIGJ1dCBpIG5lZWQgYSByZWZlcmVuY2UgdG8gaXRcbiAgZmllbGRNb2RlbDogbnVsbCxcblxuICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7XG4gICAgQmFja2JvbmUuUmFkaW8uREVCVUcgPSBERUJVR1xuXG4gICAgdGhpcy5saXN0ZW5UbyhcbiAgICAgIEJhY2tib25lLlJhZGlvLmNoYW5uZWwoJ3ZpZGVvbWFpbCcpLFxuICAgICAgJ2luaXQ6bW9kZWwnLFxuICAgICAgdGhpcy5yZWdpc3RlclZpZGVvbWFpbEZpZWxkXG4gICAgKVxuICB9LFxuXG4gIGdldEZvcm1JZDogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdmb3JtSUQnKVxuICB9LFxuXG4gIHJlZ2lzdGVyVmlkZW9tYWlsRmllbGQ6IGZ1bmN0aW9uIChmaWVsZE1vZGVsKSB7XG4gICAgLy8gd29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL3dwbmluamFzL25pbmphLWZvcm1zL2lzc3Vlcy8yNjc1XG4gICAgLy8gYWxzbyBwcmV2ZW50cyBmcm9tIGV2ZW50IGVtaXR0ZXIgbGVha3MgdW5kZXIgcmFjZSBjb25kaXRpb25zXG4gICAgaWYgKCF0aGlzLnZpZGVvbWFpbENsaWVudCkge1xuICAgICAgdGhpcy5maWVsZE1vZGVsID0gZmllbGRNb2RlbFxuXG4gICAgICB0aGlzLmxvYWRWaWRlb21haWxDbGllbnQoKVxuXG4gICAgICAvLyBjdXN0b20gZmllbGQgdmFsaWRhdGlvbiwgc2luY2Ugd2UgYXJlbid0IHVzaW5nIGEgc3RhbmRhcmQgYHZhbHVlYFxuICAgICAgLy8gZm9yIHRoZSB2aWRlb21haWwgaW5wdXRcbiAgICAgIEJhY2tib25lLlJhZGlvLmNoYW5uZWwoJ3ZpZGVvbWFpbCcpLnJlcGx5KFxuICAgICAgICAndmFsaWRhdGU6cmVxdWlyZWQnLFxuICAgICAgICB0aGlzLnZhbGlkYXRlUmVxdWlyZWQsXG4gICAgICAgIHRoaXNcbiAgICAgIClcblxuICAgICAgQmFja2JvbmUuUmFkaW8uY2hhbm5lbCgndmlkZW9tYWlsJykucmVwbHkoXG4gICAgICAgICd2YWxpZGF0ZTptb2RlbERhdGEnLFxuICAgICAgICB0aGlzLnZhbGlkYXRlVmlkZW9tYWlsLFxuICAgICAgICB0aGlzXG4gICAgICApXG5cbiAgICAgIC8vIGNvbnRyb2wgc3VibWlzc2lvbiBwcm9ncmVzcyxcbiAgICAgIC8vIHNvIHRoYXQgd2UgY2FuIFBPU1QgdG8gdGhlIFZpZGVvbWFpbCBzZXJ2ZXIgZmlyc3RcbiAgICAgIEJhY2tib25lLlJhZGlvLmNoYW5uZWwoJ2Zvcm0tJyArIHRoaXMuZ2V0Rm9ybUlkKCkpLnJlcGx5KFxuICAgICAgICAnbWF5YmU6c3VibWl0JyxcbiAgICAgICAgdGhpcy5tYXliZVN1Ym1pdCxcbiAgICAgICAgdGhpcyxcbiAgICAgICAgZmllbGRNb2RlbFxuICAgICAgKVxuICAgIH1cbiAgfSxcblxuICBsb2FkVmlkZW9tYWlsQ2xpZW50OiBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGltYWdlUXVhbGl0eVBlcmNlbnRhZ2UgPSB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdpbWFnZV9xdWFsaXR5JykgfHwgNDBcblxuICAgIGlmIChpbWFnZVF1YWxpdHlQZXJjZW50YWdlID4gMTAwKSB7XG4gICAgICBpbWFnZVF1YWxpdHlQZXJjZW50YWdlID0gMTAwXG4gICAgfSBlbHNlIGlmIChpbWFnZVF1YWxpdHlQZXJjZW50YWdlIDwgMSkge1xuICAgICAgaW1hZ2VRdWFsaXR5UGVyY2VudGFnZSA9IDFcbiAgICB9XG5cbiAgICB0aGlzLnZpZGVvbWFpbENsaWVudCA9IG5ldyBWaWRlb21haWxDbGllbnQoe1xuICAgICAgc2l0ZU5hbWU6IHRoaXMuZmllbGRNb2RlbC5nZXQoJ3NpdGVfbmFtZScpLFxuICAgICAgdmlkZW86IHtcbiAgICAgICAgbGltaXRTZWNvbmRzOiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdsaW1pdF9zZWNvbmRzJykgfHwgOTAsXG4gICAgICAgIHdpZHRoOiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCd3aWR0aCcpIHx8IDMyMCxcbiAgICAgICAgY291bnRkb3duOiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdjb3VudGRvd24nKSB8fCBmYWxzZVxuICAgICAgfSxcbiAgICAgIGF1ZGlvOiB7XG4gICAgICAgIGVuYWJsZWQ6IHRoaXMuZmllbGRNb2RlbC5nZXQoJ2F1ZGlvX2VuYWJsZWQnKSB8fCBmYWxzZVxuICAgICAgfSxcbiAgICAgIGltYWdlOiB7XG4gICAgICAgIHF1YWxpdHk6IGltYWdlUXVhbGl0eVBlcmNlbnRhZ2UgLyAxMDAgLy8gbXVzdCBiZSBhIGZsb2F0XG4gICAgICB9LFxuICAgICAgc2VsZWN0b3JzOiB7XG4gICAgICAgIHN1Ym1pdEJ1dHRvblNlbGVjdG9yOiAnLnN1Ym1pdC13cmFwIGlucHV0J1xuICAgICAgfSxcbiAgICAgIGNhbGxiYWNrczoge1xuICAgICAgICAvLyB1Z2x5IG5hbWUgZWg/XG4gICAgICAgIGFkanVzdEZvcm1EYXRhQmVmb3JlUG9zdGluZzogdGhpcy5hZGp1c3RGb3JtRGF0YUJlZm9yZVBvc3RpbmdUb1ZpZGVvbWFpbFNlcnZlci5iaW5kKHRoaXMpXG4gICAgICB9LFxuICAgICAgLy8gbGVhdmUgaXQgdG8gbmluamEgZm9ybSB0byB2YWxpZGF0ZSB0aGUgaW5wdXRzXG4gICAgICBlbmFibGVBdXRvVmFsaWRhdGlvbjogZmFsc2UsXG4gICAgICAvLyBsZWF2ZSBpdCB0byBuaW5qYSBmb3JtIHRvIGRlYWwgd2l0aCBmb3JtIHN1Ym1pc3Npb25zXG4gICAgICBlbmFibGVBdXRvU3VibWlzc2lvbjogZmFsc2UsXG4gICAgICAvLyBsb2cgYWN0aW9ucy9ldmVudHMgdG8gY29uc29sZVxuICAgICAgdmVyYm9zZTogdGhpcy5maWVsZE1vZGVsLmdldCgndmVyYm9zZScpIHx8IERFQlVHXG4gICAgfSlcblxuICAgIHRoaXMudmlkZW9tYWlsQ2xpZW50Lm9uKHRoaXMudmlkZW9tYWlsQ2xpZW50LmV2ZW50cy5QUkVWSUVXLCB0aGlzLm9uUHJldmlldy5iaW5kKHRoaXMpKVxuICAgIHRoaXMudmlkZW9tYWlsQ2xpZW50Lm9uKHRoaXMudmlkZW9tYWlsQ2xpZW50LmV2ZW50cy5TVUJNSVRURUQsIHRoaXMub25TdWJtaXR0ZWQuYmluZCh0aGlzKSlcbiAgICB0aGlzLnZpZGVvbWFpbENsaWVudC5vbih0aGlzLnZpZGVvbWFpbENsaWVudC5ldmVudHMuR09JTkdfQkFDSywgdGhpcy5vbkdvaW5nQmFjay5iaW5kKHRoaXMpKVxuXG4gICAgdGhpcy52aWRlb21haWxDbGllbnQuc2hvdygpXG4gIH0sXG5cbiAgLy8gbmVlZGVkIHRvIGdldCB0aGUgdmlkZW9tYWlsIGtleSB3aGljaCBpcyByZXF1aXJlZCBiZWZvcmVcbiAgLy8gc3VibWl0dGluZyB0byB0aGUgdmlkZW9tYWlsIHNlcnZlclxuICBvblByZXZpZXc6IGZ1bmN0aW9uIChrZXkpIHtcbiAgICB0aGlzLmZpZWxkTW9kZWwuc2V0KCd2aWRlb21haWwta2V5Jywga2V5KVxuICAgIEJhY2tib25lLlJhZGlvXG4gICAgICAuY2hhbm5lbCgnZmllbGRzJylcbiAgICAgIC8vIGNsZWFycyBhbnkgcHJldmlvdXMgZXJyb3JzXG4gICAgICAucmVxdWVzdCgncmVtb3ZlOmVycm9yJywgdGhpcy5maWVsZE1vZGVsLmdldCgnaWQnKSwgJ3JlcXVpcmVkLWVycm9yJylcbiAgfSxcblxuICBvblN1Ym1pdHRlZDogZnVuY3Rpb24gKHZpZGVvbWFpbCkge1xuICAgIHZhciBmb3JtTW9kZWwgPSBuZlJhZGlvLmNoYW5uZWwoJ2FwcCcpLnJlcXVlc3QoJ2dldDpmb3JtJywgdGhpcy5nZXRGb3JtSWQoKSlcblxuICAgIC8vIHRvZG8gaXNudCAnZm9ybS0nICsgZm9ybU1vZGVsLmdldCgnaWQnKSB0aGUgc2FtZSBhcyB0aGUgZm9ybUlEIGFscmVhZHk/XG4gICAgbmZSYWRpby5jaGFubmVsKCdmb3JtLScgKyBmb3JtTW9kZWwuZ2V0KCdpZCcpKS5yZXF1ZXN0KCdhZGQ6ZXh0cmEnLCAndmlkZW9tYWlsJywgdmlkZW9tYWlsKVxuXG4gICAgLy8gcmVzdGFydCBzdWJtaXNzaW9uIGFnYWluLCB0aGlzIHRpbWUgdG8gdGhlIHJlYWwgd3Agc2l0ZVxuICAgIG5mUmFkaW8uY2hhbm5lbCgnZm9ybS0nICsgdGhpcy5nZXRGb3JtSWQoKSkucmVxdWVzdCgnc3VibWl0JywgZm9ybU1vZGVsKVxuICB9LFxuXG4gIG9uR29pbmdCYWNrOiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5maWVsZE1vZGVsLnNldCgndmlkZW9tYWlsLWtleScsIG51bGwpXG4gICAgdGhpcy5pbnZhbGlkYXRlKClcbiAgfSxcblxuICB2YWxpZGF0ZVJlcXVpcmVkOiBmdW5jdGlvbiAoZWwsIGZpZWxkTW9kZWwpIHtcbiAgICB2YXIgdmFsaWQgPSB0aGlzLnZhbGlkYXRlVmlkZW9tYWlsKGZpZWxkTW9kZWwpXG5cbiAgICBpZiAoIXZhbGlkKSB7XG4gICAgICB0aGlzLmludmFsaWRhdGUoKVxuICAgIH1cblxuICAgIHJldHVybiB2YWxpZFxuICB9LFxuXG4gIGludmFsaWRhdGU6IGZ1bmN0aW9uICgpIHtcbiAgICAvLyBvdmVycmlkZSBkZWZhdWx0IGJlaGF2aW91ciBzbyB0aGF0IHdlIGNhbiBzZXQgb3VyIG93biBlcnJvciB0ZXh0IGhlcmVcbiAgICBCYWNrYm9uZS5SYWRpby5jaGFubmVsKCdmaWVsZHMnKS5yZXF1ZXN0KFxuICAgICAgJ2FkZDplcnJvcicsXG4gICAgICB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdpZCcpLFxuICAgICAgJ3JlcXVpcmVkLWVycm9yJyxcbiAgICAgICdSZWNvcmQgYW5kIGNsaWNrIG9uIHN0b3AgdG8gc2VlIGEgcHJldmlldyB2aWRlby4nXG4gICAgKVxuICB9LFxuXG4gIHZhbGlkYXRlVmlkZW9tYWlsOiBmdW5jdGlvbiAoZmllbGRNb2RlbCkge1xuICAgIGZpZWxkTW9kZWwgPSBmaWVsZE1vZGVsIHx8IHRoaXMuZmllbGRNb2RlbFxuICAgIHJldHVybiBmaWVsZE1vZGVsLmdldCgndmlkZW9tYWlsLWtleScpIHx8IGZhbHNlXG4gIH0sXG5cbiAgaGFzRXJyb3JzOiBmdW5jdGlvbiAoZm9ybU1vZGVsKSB7XG4gICAgcmV0dXJuIGZvcm1Nb2RlbC5nZXQoJ2Vycm9ycycpLmxlbmd0aCA+IDBcbiAgfSxcblxuICBtYXliZVN1Ym1pdDogZnVuY3Rpb24gKGZvcm1Nb2RlbCkge1xuICAgIHZhciBtYXliZSA9IHRydWVcbiAgICB2YXIgdmlkZW9tYWlsU3VibWl0dGVkID0gZm9ybU1vZGVsLmdldEV4dHJhKCd2aWRlb21haWwnKVxuICAgIHZhciB2aWRlb21haWxSZWNvcmRlZCA9IHRoaXMudmFsaWRhdGVWaWRlb21haWwoKVxuICAgIHZhciBlcnJvcm5lb3VzID0gdGhpcy5oYXNFcnJvcnMoZm9ybU1vZGVsKVxuXG4gICAgLy8gaG9sZCBvbiB3aXRoIGZpbmFsIGZvcm0gc3VibWlzc2lvbiB3aGVuIG9uZSB3YXMgcmVjb3JkZWRcbiAgICAvLyBidXQgaGFzbid0IGJlZW4gc3VibWl0dGVkIHRvIHRoZSB2aWRlb21haWwgc2VydmVyIHlldFxuICAgIGlmICghdmlkZW9tYWlsU3VibWl0dGVkICYmICFlcnJvcm5lb3VzICYmIHZpZGVvbWFpbFJlY29yZGVkKSB7XG4gICAgICB0aGlzLnZpZGVvbWFpbENsaWVudC5zdWJtaXQoKVxuICAgICAgbWF5YmUgPSBmYWxzZVxuICAgIH1cblxuICAgIHJldHVybiBtYXliZVxuICB9LFxuXG4gIGdldE1lcmdlVGFnVmFsdWU6IGZ1bmN0aW9uIChmaWVsZEtleSwgZm9ybVZhbHVlcykge1xuICAgIHZhciB2YWx1ZSA9IHRoaXMuZmllbGRNb2RlbC5nZXQoZmllbGRLZXkpXG5cbiAgICAvLyBpdCBjYW4gaGFwcGVuIHRoYXQgdGhlIHVzZXIgaGFzIGNvbmZpZ3VyZWQgc29tZXRoaW5nIHdyb25nLFxuICAgIC8vIGkuRS4gYW4gZW1wdHkgZW1haWxfZnJvbS4gaW4gdGhhdCBjYXNlIGp1c3QgaWdub3JlIC4uLlxuICAgIGlmICh2YWx1ZSkge1xuICAgICAgLy8gYWRtaW4gZW1haWwgbG9jYWxpemVkIGZyb20gYmFja2VuZCwgYSBiaXQgdWdseVxuICAgICAgLy8gdG9kbyBhc2sgZm9yIGFuIGVuZHBvaW50IHRvIHByb2Nlc3MgdGhvc2Ugc3BlY2lhbCBtZXJnZSB0YWdzXG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vd3BuaW5qYXMvbmluamEtZm9ybXMtdmlkZW9tYWlsL2lzc3Vlcy8zMFxuICAgICAgaWYgKHZhbHVlID09PSAne3dwOmFkbWluX2VtYWlsfScpIHtcbiAgICAgICAgdmFsdWUgPSB3aW5kb3cubmZWaWRlb21haWwuYWRtaW5fZW1haWxcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciByYXdGaWVsZEtleSA9IHZhbHVlLnJlcGxhY2UoJ3tmaWVsZDonLCAnJykucmVwbGFjZSgnfScsICcnKVxuXG4gICAgICAgIGlmIChyYXdGaWVsZEtleSAhPT0gdmFsdWUpIHtcbiAgICAgICAgICAvLyB5ZXMgaXQgd2FzIGEgbWVyZ2UgdGFnLCBzbyB1c2UgaXRcbiAgICAgICAgICB2YWx1ZSA9IGZvcm1WYWx1ZXNbcmF3RmllbGRLZXldXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdmFsdWVcbiAgfSxcblxuICBnZXRGb3JtVmFsdWVzOiBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGZvcm1Nb2RlbCA9IEJhY2tib25lLlJhZGlvLmNoYW5uZWwoJ2FwcCcpLnJlcXVlc3QoJ2dldDpmb3JtJywgdGhpcy5nZXRGb3JtSWQoKSlcbiAgICB2YXIgZmllbGRzQ29sbGVjdGlvbiA9IGZvcm1Nb2RlbC5nZXQoJ2ZpZWxkcycpXG5cbiAgICByZXR1cm4gZmllbGRzQ29sbGVjdGlvbi5yZWR1Y2UoZnVuY3Rpb24gKG1lbW8sIGZpZWxkKSB7XG4gICAgICBtZW1vW2ZpZWxkLmdldCgna2V5JyldID0gZmllbGQuZ2V0KCd2YWx1ZScpXG4gICAgICByZXR1cm4gbWVtb1xuICAgIH0sIHt9KVxuICB9LFxuXG4gIGFkanVzdEZvcm1EYXRhQmVmb3JlUG9zdGluZ1RvVmlkZW9tYWlsU2VydmVyOiBmdW5jdGlvbiAodmlkZW9tYWlsLCBjYikge1xuICAgIHZhciBmb3JtVmFsdWVzID0gdGhpcy5nZXRGb3JtVmFsdWVzKClcblxuICAgIHZpZGVvbWFpbC5mcm9tID0gdGhpcy5nZXRNZXJnZVRhZ1ZhbHVlKCdlbWFpbF9mcm9tJywgZm9ybVZhbHVlcylcbiAgICB2aWRlb21haWwudG8gPSB0aGlzLmdldE1lcmdlVGFnVmFsdWUoJ2VtYWlsX3RvJywgZm9ybVZhbHVlcylcbiAgICB2aWRlb21haWwuc3ViamVjdCA9IHRoaXMuZ2V0TWVyZ2VUYWdWYWx1ZSgnZW1haWxfc3ViamVjdCcsIGZvcm1WYWx1ZXMpXG4gICAgdmlkZW9tYWlsLmJvZHkgPSB0aGlzLmdldE1lcmdlVGFnVmFsdWUoJ2VtYWlsX2JvZHknLCBmb3JtVmFsdWVzKVxuXG4gICAgY2IobnVsbCwgdmlkZW9tYWlsKVxuICB9LFxuXG4gIG9uQmVmb3JlRGVzdHJveTogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMudmlkZW9tYWlsQ2xpZW50LnVubG9hZCgpXG4gICAgZGVsZXRlIHRoaXMudmlkZW9tYWlsQ2xpZW50XG4gIH1cbn0pXG5cbmpRdWVyeShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24gKCkge1xuICByZXR1cm4gbmV3IFZpZGVvbWFpbEZpZWxkQ29udHJvbGxlcigpXG59KVxuIl19
