var DEBUG=!1,VideomailFieldController=Marionette.Object.extend({videomailClient:null,fieldModel:null,initialize:function(){Backbone.Radio.DEBUG=DEBUG,this.listenTo(Backbone.Radio.channel("videomail"),"init:model",this.registerVideomailField)},getFormId:function(){return this.fieldModel.get("formID")},registerVideomailField:function(e){this.videomailClient||(this.fieldModel=e,this.loadVideomailClient(),Backbone.Radio.channel("videomail").reply("validate:required",this.validateRequired,this),Backbone.Radio.channel("videomail").reply("validate:modelData",this.validateVideomail,this),Backbone.Radio.channel("form-"+this.getFormId()).reply("maybe:submit",this.maybeSubmit,this,e))},loadVideomailClient:function(){var e=this.fieldModel.get("image_quality")||40;e>100?e=100:e<1&&(e=1),this.videomailClient=new VideomailClient({siteName:this.fieldModel.get("site_name"),video:{limitSeconds:this.fieldModel.get("limit_seconds")||90,width:this.fieldModel.get("width")||320,countdown:this.fieldModel.get("countdown")||!1},audio:{enabled:this.fieldModel.get("audio_enabled")},image:{quality:e/100},selectors:{submitButtonSelector:".submit-wrap input"},callbacks:{adjustFormDataBeforePosting:this.adjustFormDataBeforePostingToVideomailServer.bind(this)},enableAutoValidation:!1,enableAutoSubmission:!1,verbose:this.fieldModel.get("verbose")||DEBUG}),this.videomailClient.on(this.videomailClient.events.PREVIEW,this.onPreview.bind(this)),this.videomailClient.on(this.videomailClient.events.SUBMITTED,this.onSubmitted.bind(this)),this.videomailClient.on(this.videomailClient.events.GOING_BACK,this.onGoingBack.bind(this)),this.videomailClient.show()},onPreview:function(e){this.fieldModel.set("videomail-key",e),Backbone.Radio.channel("fields").request("remove:error",this.fieldModel.get("id"),"required-error")},onSubmitted:function(e){var i=nfRadio.channel("app").request("get:form",this.getFormId());nfRadio.channel("form-"+i.get("id")).request("add:extra","videomail",e),nfRadio.channel("form-"+this.getFormId()).request("submit",i)},onGoingBack:function(){this.fieldModel.set("videomail-key",null),this.invalidate()},validateRequired:function(e,i){var t=this.validateVideomail(i);return t||this.invalidate(),t},invalidate:function(){Backbone.Radio.channel("fields").request("add:error",this.fieldModel.get("id"),"required-error","Record and click on stop to see a preview video.")},validateVideomail:function(e){return(e=e||this.fieldModel).get("videomail-key")||!1},hasErrors:function(e){return e.get("errors").length>0},maybeSubmit:function(e){var i=!0,t=e.getExtra("videomail"),o=this.validateVideomail(),l=this.hasErrors(e);return t||l||!o||(this.videomailClient.submit(),i=!1),i},getMergeTagValue:function(e,i){var t=this.fieldModel.get(e);if(t)if("{wp:admin_email}"===t)t=window.nfVideomail.admin_email;else{var o=t.match(/{field:(.*)}/i),l=o&&o[1];l!==t&&(t=t.replace(/{field:(.*)}/i,i[l]))}return t},getFormValues:function(){return Backbone.Radio.channel("app").request("get:form",this.getFormId()).get("fields").reduce(function(e,i){return e[i.get("key")]=i.get("value"),e},{})},adjustFormDataBeforePostingToVideomailServer:function(e,i){var t=this.getFormValues();e.from=this.getMergeTagValue("email_from",t),e.to=this.getMergeTagValue("email_to",t),e.subject=this.getMergeTagValue("email_subject",t),e.body=this.getMergeTagValue("email_body",t),i(null,e)},onBeforeDestroy:function(){this.videomailClient.unload(),delete this.videomailClient}});jQuery(document).ready(function(){return new VideomailFieldController});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsiREVCVUciLCJWaWRlb21haWxGaWVsZENvbnRyb2xsZXIiLCJNYXJpb25ldHRlIiwiT2JqZWN0IiwiZXh0ZW5kIiwidmlkZW9tYWlsQ2xpZW50IiwiZmllbGRNb2RlbCIsImluaXRpYWxpemUiLCJCYWNrYm9uZSIsIlJhZGlvIiwidGhpcyIsImxpc3RlblRvIiwiY2hhbm5lbCIsInJlZ2lzdGVyVmlkZW9tYWlsRmllbGQiLCJnZXRGb3JtSWQiLCJnZXQiLCJsb2FkVmlkZW9tYWlsQ2xpZW50IiwicmVwbHkiLCJ2YWxpZGF0ZVJlcXVpcmVkIiwidmFsaWRhdGVWaWRlb21haWwiLCJtYXliZVN1Ym1pdCIsImltYWdlUXVhbGl0eVBlcmNlbnRhZ2UiLCJWaWRlb21haWxDbGllbnQiLCJzaXRlTmFtZSIsInZpZGVvIiwibGltaXRTZWNvbmRzIiwid2lkdGgiLCJjb3VudGRvd24iLCJhdWRpbyIsImVuYWJsZWQiLCJpbWFnZSIsInF1YWxpdHkiLCJzZWxlY3RvcnMiLCJzdWJtaXRCdXR0b25TZWxlY3RvciIsImNhbGxiYWNrcyIsImFkanVzdEZvcm1EYXRhQmVmb3JlUG9zdGluZyIsImFkanVzdEZvcm1EYXRhQmVmb3JlUG9zdGluZ1RvVmlkZW9tYWlsU2VydmVyIiwiYmluZCIsImVuYWJsZUF1dG9WYWxpZGF0aW9uIiwiZW5hYmxlQXV0b1N1Ym1pc3Npb24iLCJ2ZXJib3NlIiwib24iLCJldmVudHMiLCJQUkVWSUVXIiwib25QcmV2aWV3IiwiU1VCTUlUVEVEIiwib25TdWJtaXR0ZWQiLCJHT0lOR19CQUNLIiwib25Hb2luZ0JhY2siLCJzaG93Iiwia2V5Iiwic2V0IiwicmVxdWVzdCIsInZpZGVvbWFpbCIsImZvcm1Nb2RlbCIsIm5mUmFkaW8iLCJpbnZhbGlkYXRlIiwiZWwiLCJ2YWxpZCIsImhhc0Vycm9ycyIsImxlbmd0aCIsIm1heWJlIiwidmlkZW9tYWlsU3VibWl0dGVkIiwiZ2V0RXh0cmEiLCJ2aWRlb21haWxSZWNvcmRlZCIsImVycm9ybmVvdXMiLCJzdWJtaXQiLCJnZXRNZXJnZVRhZ1ZhbHVlIiwiZmllbGRLZXkiLCJmb3JtVmFsdWVzIiwidmFsdWUiLCJ3aW5kb3ciLCJuZlZpZGVvbWFpbCIsImFkbWluX2VtYWlsIiwicmF3RmllbGRLZXlNYXRjaGVzIiwibWF0Y2giLCJyYXdGaWVsZEtleSIsInJlcGxhY2UiLCJnZXRGb3JtVmFsdWVzIiwicmVkdWNlIiwibWVtbyIsImZpZWxkIiwiY2IiLCJmcm9tIiwidG8iLCJzdWJqZWN0IiwiYm9keSIsIm9uQmVmb3JlRGVzdHJveSIsInVubG9hZCIsImpRdWVyeSIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiJBQUNBLElBQUlBLE9BQVEsRUFLUkMseUJBQTJCQyxXQUFXQyxPQUFPQyxRQUUvQ0MsZ0JBQWlCLEtBR2pCQyxXQUFZLEtBRVpDLFdBQVksV0FDVkMsU0FBU0MsTUFBTVQsTUFBUUEsTUFFdkJVLEtBQUtDLFNBQ0hILFNBQVNDLE1BQU1HLFFBQVEsYUFDdkIsYUFDQUYsS0FBS0cseUJBSVRDLFVBQVcsV0FDVCxPQUFPSixLQUFLSixXQUFXUyxJQUFJLFdBRzdCRix1QkFBd0IsU0FBVVAsR0FHM0JJLEtBQUtMLGtCQUNSSyxLQUFLSixXQUFhQSxFQUVsQkksS0FBS00sc0JBSUxSLFNBQVNDLE1BQU1HLFFBQVEsYUFBYUssTUFDbEMsb0JBQ0FQLEtBQUtRLGlCQUNMUixNQUdGRixTQUFTQyxNQUFNRyxRQUFRLGFBQWFLLE1BQ2xDLHFCQUNBUCxLQUFLUyxrQkFDTFQsTUFLRkYsU0FBU0MsTUFBTUcsUUFBUSxRQUFVRixLQUFLSSxhQUFhRyxNQUNqRCxlQUNBUCxLQUFLVSxZQUNMVixLQUNBSixLQUtOVSxvQkFBcUIsV0FDbkIsSUFBSUssRUFBeUJYLEtBQUtKLFdBQVdTLElBQUksa0JBQW9CLEdBRWpFTSxFQUF5QixJQUMzQkEsRUFBeUIsSUFDaEJBLEVBQXlCLElBQ2xDQSxFQUF5QixHQUczQlgsS0FBS0wsZ0JBQWtCLElBQUlpQixpQkFDekJDLFNB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SSxRQUFVa0UsRUFBTWxFLElBQUksU0FDNUJpRSxRQUlYNUMsNkNBQThDLFNBQVVpQixFQUFXNkIsR0FDakUsSUFBSWIsRUFBYTNELEtBQUtvRSxnQkFFdEJ6QixFQUFVOEIsS0FBT3pFLEtBQUt5RCxpQkFBaUIsYUFBY0UsR0FDckRoQixFQUFVK0IsR0FBSzFFLEtBQUt5RCxpQkFBaUIsV0FBWUUsR0FDakRoQixFQUFVZ0MsUUFBVTNFLEtBQUt5RCxpQkFBaUIsZ0JBQWlCRSxHQUMzRGhCLEVBQVVpQyxLQUFPNUUsS0FBS3lELGlCQUFpQixhQUFjRSxHQUVyRGEsRUFBRyxLQUFNN0IsSUFHWGtDLGdCQUFpQixXQUNmN0UsS0FBS0wsZ0JBQWdCbUYsZ0JBQ2Q5RSxLQUFLTCxtQkFJaEJvRixPQUFPQyxVQUFVQyxNQUFNLFdBQ3JCLE9BQU8sSUFBSTFGIiwiZmlsZSI6Im1haW4ubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gbWFudWFsIHN3aXRjaCB0byBoYXZlIG1vcmUgc3R1ZmYgcHJpbnRlZCB0byBjb25zb2xlXG52YXIgREVCVUcgPSBmYWxzZVxuXG4vLyBnb29kIGRvY3VtZW50YXRpb24gb24gYmFja2JvbmUgZXZlbnQgaGFuZGxpbmdcbi8vIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZy8jRXZlbnRzXG5cbnZhciBWaWRlb21haWxGaWVsZENvbnRyb2xsZXIgPSBNYXJpb25ldHRlLk9iamVjdC5leHRlbmQoe1xuXG4gIHZpZGVvbWFpbENsaWVudDogbnVsbCxcblxuICAvLyBub3Qgc3VyZSBpZiB0aGlzIGlzIGEgZ29vZCBpZGVhLCBidXQgaSBuZWVkIGEgcmVmZXJlbmNlIHRvIGl0XG4gIGZpZWxkTW9kZWw6IG51bGwsXG5cbiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKCkge1xuICAgIEJhY2tib25lLlJhZGlvLkRFQlVHID0gREVCVUdcblxuICAgIHRoaXMubGlzdGVuVG8oXG4gICAgICBCYWNrYm9uZS5SYWRpby5jaGFubmVsKCd2aWRlb21haWwnKSxcbiAgICAgICdpbml0Om1vZGVsJyxcbiAgICAgIHRoaXMucmVnaXN0ZXJWaWRlb21haWxGaWVsZFxuICAgIClcbiAgfSxcblxuICBnZXRGb3JtSWQ6IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gdGhpcy5maWVsZE1vZGVsLmdldCgnZm9ybUlEJylcbiAgfSxcblxuICByZWdpc3RlclZpZGVvbWFpbEZpZWxkOiBmdW5jdGlvbiAoZmllbGRNb2RlbCkge1xuICAgIC8vIHdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS93cG5pbmphcy9uaW5qYS1mb3Jtcy9pc3N1ZXMvMjY3NVxuICAgIC8vIGFsc28gcHJldmVudHMgZnJvbSBldmVudCBlbWl0dGVyIGxlYWtzIHVuZGVyIHJhY2UgY29uZGl0aW9uc1xuICAgIGlmICghdGhpcy52aWRlb21haWxDbGllbnQpIHtcbiAgICAgIHRoaXMuZmllbGRNb2RlbCA9IGZpZWxkTW9kZWxcblxuICAgICAgdGhpcy5sb2FkVmlkZW9tYWlsQ2xpZW50KClcblxuICAgICAgLy8gY3VzdG9tIGZpZWxkIHZhbGlkYXRpb24sIHNpbmNlIHdlIGFyZW4ndCB1c2luZyBhIHN0YW5kYXJkIGB2YWx1ZWBcbiAgICAgIC8vIGZvciB0aGUgdmlkZW9tYWlsIGlucHV0XG4gICAgICBCYWNrYm9uZS5SYWRpby5jaGFubmVsKCd2aWRlb21haWwnKS5yZXBseShcbiAgICAgICAgJ3ZhbGlkYXRlOnJlcXVpcmVkJyxcbiAgICAgICAgdGhpcy52YWxpZGF0ZVJlcXVpcmVkLFxuICAgICAgICB0aGlzXG4gICAgICApXG5cbiAgICAgIEJhY2tib25lLlJhZGlvLmNoYW5uZWwoJ3ZpZGVvbWFpbCcpLnJlcGx5KFxuICAgICAgICAndmFsaWRhdGU6bW9kZWxEYXRhJyxcbiAgICAgICAgdGhpcy52YWxpZGF0ZVZpZGVvbWFpbCxcbiAgICAgICAgdGhpc1xuICAgICAgKVxuXG4gICAgICAvLyBjb250cm9sIHN1Ym1pc3Npb24gcHJvZ3Jlc3MsXG4gICAgICAvLyBzbyB0aGF0IHdlIGNhbiBQT1NUIHRvIHRoZSBWaWRlb21haWwgc2VydmVyIGZpcnN0XG4gICAgICBCYWNrYm9uZS5SYWRpby5jaGFubmVsKCdmb3JtLScgKyB0aGlzLmdldEZvcm1JZCgpKS5yZXBseShcbiAgICAgICAgJ21heWJlOnN1Ym1pdCcsXG4gICAgICAgIHRoaXMubWF5YmVTdWJtaXQsXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGZpZWxkTW9kZWxcbiAgICAgIClcbiAgICB9XG4gIH0sXG5cbiAgbG9hZFZpZGVvbWFpbENsaWVudDogZnVuY3Rpb24gKCkge1xuICAgIHZhciBpbWFnZVF1YWxpdHlQZXJjZW50YWdlID0gdGhpcy5maWVsZE1vZGVsLmdldCgnaW1hZ2VfcXVhbGl0eScpIHx8IDQwXG5cbiAgICBpZiAoaW1hZ2VRdWFsaXR5UGVyY2VudGFnZSA+IDEwMCkge1xuICAgICAgaW1hZ2VRdWFsaXR5UGVyY2VudGFnZSA9IDEwMFxuICAgIH0gZWxzZSBpZiAoaW1hZ2VRdWFsaXR5UGVyY2VudGFnZSA8IDEpIHtcbiAgICAgIGltYWdlUXVhbGl0eVBlcmNlbnRhZ2UgPSAxXG4gICAgfVxuXG4gICAgdGhpcy52aWRlb21haWxDbGllbnQgPSBuZXcgVmlkZW9tYWlsQ2xpZW50KHtcbiAgICAgIHNpdGVOYW1lOiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdzaXRlX25hbWUnKSxcbiAgICAgIHZpZGVvOiB7XG4gICAgICAgIGxpbWl0U2Vjb25kczogdGhpcy5maWVsZE1vZGVsLmdldCgnbGltaXRfc2Vjb25kcycpIHx8IDkwLFxuICAgICAgICB3aWR0aDogdGhpcy5maWVsZE1vZGVsLmdldCgnd2lkdGgnKSB8fCAzMjAsXG4gICAgICAgIGNvdW50ZG93bjogdGhpcy5maWVsZE1vZGVsLmdldCgnY291bnRkb3duJykgfHwgZmFsc2VcbiAgICAgIH0sXG4gICAgICBhdWRpbzoge1xuICAgICAgICBlbmFibGVkOiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdhdWRpb19lbmFibGVkJylcbiAgICAgIH0sXG4gICAgICBpbWFnZToge1xuICAgICAgICBxdWFsaXR5OiBpbWFnZVF1YWxpdHlQZXJjZW50YWdlIC8gMTAwIC8vIG11c3QgYmUgYSBmbG9hdFxuICAgICAgfSxcbiAgICAgIHNlbGVjdG9yczoge1xuICAgICAgICBzdWJtaXRCdXR0b25TZWxlY3RvcjogJy5zdWJtaXQtd3JhcCBpbnB1dCdcbiAgICAgIH0sXG4gICAgICBjYWxsYmFja3M6IHtcbiAgICAgICAgLy8gdWdseSBuYW1lIGVoP1xuICAgICAgICBhZGp1c3RGb3JtRGF0YUJlZm9yZVBvc3Rpbmc6IHRoaXMuYWRqdXN0Rm9ybURhdGFCZWZvcmVQb3N0aW5nVG9WaWRlb21haWxTZXJ2ZXIuYmluZCh0aGlzKVxuICAgICAgfSxcbiAgICAgIC8vIGxlYXZlIGl0IHRvIG5pbmphIGZvcm0gdG8gdmFsaWRhdGUgdGhlIGlucHV0c1xuICAgICAgZW5hYmxlQXV0b1ZhbGlkYXRpb246IGZhbHNlLFxuICAgICAgLy8gbGVhdmUgaXQgdG8gbmluamEgZm9ybSB0byBkZWFsIHdpdGggZm9ybSBzdWJtaXNzaW9uc1xuICAgICAgZW5hYmxlQXV0b1N1Ym1pc3Npb246IGZhbHNlLFxuICAgICAgLy8gbG9nIGFjdGlvbnMvZXZlbnRzIHRvIGNvbnNvbGVcbiAgICAgIHZlcmJvc2U6IHRoaXMuZmllbGRNb2RlbC5nZXQoJ3ZlcmJvc2UnKSB8fCBERUJVR1xuICAgIH0pXG5cbiAgICB0aGlzLnZpZGVvbWFpbENsaWVudC5vbih0aGlzLnZpZGVvbWFpbENsaWVudC5ldmVudHMuUFJFVklFVywgdGhpcy5vblByZXZpZXcuYmluZCh0aGlzKSlcbiAgICB0aGlzLnZpZGVvbWFpbENsaWVudC5vbih0aGlzLnZpZGVvbWFpbENsaWVudC5ldmVudHMuU1VCTUlUVEVELCB0aGlzLm9uU3VibWl0dGVkLmJpbmQodGhpcykpXG4gICAgdGhpcy52aWRlb21haWxDbGllbnQub24odGhpcy52aWRlb21haWxDbGllbnQuZXZlbnRzLkdPSU5HX0JBQ0ssIHRoaXMub25Hb2luZ0JhY2suYmluZCh0aGlzKSlcblxuICAgIHRoaXMudmlkZW9tYWlsQ2xpZW50LnNob3coKVxuICB9LFxuXG4gIC8vIG5lZWRlZCB0byBnZXQgdGhlIHZpZGVvbWFpbCBrZXkgd2hpY2ggaXMgcmVxdWlyZWQgYmVmb3JlXG4gIC8vIHN1Ym1pdHRpbmcgdG8gdGhlIHZpZGVvbWFpbCBzZXJ2ZXJcbiAgb25QcmV2aWV3OiBmdW5jdGlvbiAoa2V5KSB7XG4gICAgdGhpcy5maWVsZE1vZGVsLnNldCgndmlkZW9tYWlsLWtleScsIGtleSlcbiAgICBCYWNrYm9uZS5SYWRpb1xuICAgICAgLmNoYW5uZWwoJ2ZpZWxkcycpXG4gICAgICAvLyBjbGVhcnMgYW55IHByZXZpb3VzIGVycm9yc1xuICAgICAgLnJlcXVlc3QoJ3JlbW92ZTplcnJvcicsIHRoaXMuZmllbGRNb2RlbC5nZXQoJ2lkJyksICdyZXF1aXJlZC1lcnJvcicpXG4gIH0sXG5cbiAgb25TdWJtaXR0ZWQ6IGZ1bmN0aW9uICh2aWRlb21haWwpIHtcbiAgICB2YXIgZm9ybU1vZGVsID0gbmZSYWRpby5jaGFubmVsKCdhcHAnKS5yZXF1ZXN0KCdnZXQ6Zm9ybScsIHRoaXMuZ2V0Rm9ybUlkKCkpXG5cbiAgICAvLyB0b2RvIGlzbnQgJ2Zvcm0tJyArIGZvcm1Nb2RlbC5nZXQoJ2lkJykgdGhlIHNhbWUgYXMgdGhlIGZvcm1JRCBhbHJlYWR5P1xuICAgIG5mUmFkaW8uY2hhbm5lbCgnZm9ybS0nICsgZm9ybU1vZGVsLmdldCgnaWQnKSkucmVxdWVzdCgnYWRkOmV4dHJhJywgJ3ZpZGVvbWFpbCcsIHZpZGVvbWFpbClcblxuICAgIC8vIHJlc3RhcnQgc3VibWlzc2lvbiBhZ2FpbiwgdGhpcyB0aW1lIHRvIHRoZSByZWFsIHdwIHNpdGVcbiAgICBuZlJhZGlvLmNoYW5uZWwoJ2Zvcm0tJyArIHRoaXMuZ2V0Rm9ybUlkKCkpLnJlcXVlc3QoJ3N1Ym1pdCcsIGZvcm1Nb2RlbClcbiAgfSxcblxuICBvbkdvaW5nQmFjazogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuZmllbGRNb2RlbC5zZXQoJ3ZpZGVvbWFpbC1rZXknLCBudWxsKVxuICAgIHRoaXMuaW52YWxpZGF0ZSgpXG4gIH0sXG5cbiAgdmFsaWRhdGVSZXF1aXJlZDogZnVuY3Rpb24gKGVsLCBmaWVsZE1vZGVsKSB7XG4gICAgdmFyIHZhbGlkID0gdGhpcy52YWxpZGF0ZVZpZGVvbWFpbChmaWVsZE1vZGVsKVxuXG4gICAgaWYgKCF2YWxpZCkge1xuICAgICAgdGhpcy5pbnZhbGlkYXRlKClcbiAgICB9XG5cbiAgICByZXR1cm4gdmFsaWRcbiAgfSxcblxuICBpbnZhbGlkYXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgLy8gb3ZlcnJpZGUgZGVmYXVsdCBiZWhhdmlvdXIgc28gdGhhdCB3ZSBjYW4gc2V0IG91ciBvd24gZXJyb3IgdGV4dCBoZXJlXG4gICAgQmFja2JvbmUuUmFkaW8uY2hhbm5lbCgnZmllbGRzJykucmVxdWVzdChcbiAgICAgICdhZGQ6ZXJyb3InLFxuICAgICAgdGhpcy5maWVsZE1vZGVsLmdldCgnaWQnKSxcbiAgICAgICdyZXF1aXJlZC1lcnJvcicsXG4gICAgICAnUmVjb3JkIGFuZCBjbGljayBvbiBzdG9wIHRvIHNlZSBhIHByZXZpZXcgdmlkZW8uJ1xuICAgIClcbiAgfSxcblxuICB2YWxpZGF0ZVZpZGVvbWFpbDogZnVuY3Rpb24gKGZpZWxkTW9kZWwpIHtcbiAgICBmaWVsZE1vZGVsID0gZmllbGRNb2RlbCB8fCB0aGlzLmZpZWxkTW9kZWxcbiAgICByZXR1cm4gZmllbGRNb2RlbC5nZXQoJ3ZpZGVvbWFpbC1rZXknKSB8fCBmYWxzZVxuICB9LFxuXG4gIGhhc0Vycm9yczogZnVuY3Rpb24gKGZvcm1Nb2RlbCkge1xuICAgIHJldHVybiBmb3JtTW9kZWwuZ2V0KCdlcnJvcnMnKS5sZW5ndGggPiAwXG4gIH0sXG5cbiAgbWF5YmVTdWJtaXQ6IGZ1bmN0aW9uIChmb3JtTW9kZWwpIHtcbiAgICB2YXIgbWF5YmUgPSB0cnVlXG4gICAgdmFyIHZpZGVvbWFpbFN1Ym1pdHRlZCA9IGZvcm1Nb2RlbC5nZXRFeHRyYSgndmlkZW9tYWlsJylcbiAgICB2YXIgdmlkZW9tYWlsUmVjb3JkZWQgPSB0aGlzLnZhbGlkYXRlVmlkZW9tYWlsKClcbiAgICB2YXIgZXJyb3JuZW91cyA9IHRoaXMuaGFzRXJyb3JzKGZvcm1Nb2RlbClcblxuICAgIC8vIGhvbGQgb24gd2l0aCBmaW5hbCBmb3JtIHN1Ym1pc3Npb24gd2hlbiBvbmUgd2FzIHJlY29yZGVkXG4gICAgLy8gYnV0IGhhc24ndCBiZWVuIHN1Ym1pdHRlZCB0byB0aGUgdmlkZW9tYWlsIHNlcnZlciB5ZXRcbiAgICBpZiAoIXZpZGVvbWFpbFN1Ym1pdHRlZCAmJiAhZXJyb3JuZW91cyAmJiB2aWRlb21haWxSZWNvcmRlZCkge1xuICAgICAgdGhpcy52aWRlb21haWxDbGllbnQuc3VibWl0KClcbiAgICAgIG1heWJlID0gZmFsc2VcbiAgICB9XG5cbiAgICByZXR1cm4gbWF5YmVcbiAgfSxcblxuICBnZXRNZXJnZVRhZ1ZhbHVlOiBmdW5jdGlvbiAoZmllbGRLZXksIGZvcm1WYWx1ZXMpIHtcbiAgICB2YXIgdmFsdWUgPSB0aGlzLmZpZWxkTW9kZWwuZ2V0KGZpZWxkS2V5KVxuXG4gICAgLy8gaXQgY2FuIGhhcHBlbiB0aGF0IHRoZSB1c2VyIGhhcyBjb25maWd1cmVkIHNvbWV0aGluZyB3cm9uZyxcbiAgICAvLyBpLkUuIGFuIGVtcHR5IGVtYWlsX2Zyb20uIGluIHRoYXQgY2FzZSBqdXN0IGlnbm9yZSAuLi5cbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIC8vIGFkbWluIGVtYWlsIGxvY2FsaXplZCBmcm9tIGJhY2tlbmQsIGEgYml0IHVnbHlcbiAgICAgIC8vIHRvZG8gYXNrIGZvciBhbiBlbmRwb2ludCB0byBwcm9jZXNzIHRob3NlIHNwZWNpYWwgbWVyZ2UgdGFnc1xuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2JpbmFyeWtpdGNoZW4vdmlkZW9tYWlsLWZvci1uaW5qYS1mb3Jtcy9pc3N1ZXMvMzBcbiAgICAgIGlmICh2YWx1ZSA9PT0gJ3t3cDphZG1pbl9lbWFpbH0nKSB7XG4gICAgICAgIHZhbHVlID0gd2luZG93Lm5mVmlkZW9tYWlsLmFkbWluX2VtYWlsXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgcmF3RmllbGRLZXlNYXRjaGVzID0gdmFsdWUubWF0Y2goL3tmaWVsZDooLiopfS9pKVxuICAgICAgICB2YXIgcmF3RmllbGRLZXkgPSByYXdGaWVsZEtleU1hdGNoZXMgJiYgcmF3RmllbGRLZXlNYXRjaGVzWzFdXG5cbiAgICAgICAgaWYgKHJhd0ZpZWxkS2V5ICE9PSB2YWx1ZSkge1xuICAgICAgICAgIC8vIHllcyBpdCB3YXMgYSBtZXJnZSB0YWcsIHNvIHVzZSBpdFxuICAgICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgve2ZpZWxkOiguKil9L2ksIGZvcm1WYWx1ZXNbcmF3RmllbGRLZXldKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHZhbHVlXG4gIH0sXG5cbiAgZ2V0Rm9ybVZhbHVlczogZnVuY3Rpb24gKCkge1xuICAgIHZhciBmb3JtTW9kZWwgPSBCYWNrYm9uZS5SYWRpby5jaGFubmVsKCdhcHAnKS5yZXF1ZXN0KCdnZXQ6Zm9ybScsIHRoaXMuZ2V0Rm9ybUlkKCkpXG4gICAgdmFyIGZpZWxkc0NvbGxlY3Rpb24gPSBmb3JtTW9kZWwuZ2V0KCdmaWVsZHMnKVxuXG4gICAgcmV0dXJuIGZpZWxkc0NvbGxlY3Rpb24ucmVkdWNlKGZ1bmN0aW9uIChtZW1vLCBmaWVsZCkge1xuICAgICAgbWVtb1tmaWVsZC5nZXQoJ2tleScpXSA9IGZpZWxkLmdldCgndmFsdWUnKVxuICAgICAgcmV0dXJuIG1lbW9cbiAgICB9LCB7fSlcbiAgfSxcblxuICBhZGp1c3RGb3JtRGF0YUJlZm9yZVBvc3RpbmdUb1ZpZGVvbWFpbFNlcnZlcjogZnVuY3Rpb24gKHZpZGVvbWFpbCwgY2IpIHtcbiAgICB2YXIgZm9ybVZhbHVlcyA9IHRoaXMuZ2V0Rm9ybVZhbHVlcygpXG5cbiAgICB2aWRlb21haWwuZnJvbSA9IHRoaXMuZ2V0TWVyZ2VUYWdWYWx1ZSgnZW1haWxfZnJvbScsIGZvcm1WYWx1ZXMpXG4gICAgdmlkZW9tYWlsLnRvID0gdGhpcy5nZXRNZXJnZVRhZ1ZhbHVlKCdlbWFpbF90bycsIGZvcm1WYWx1ZXMpXG4gICAgdmlkZW9tYWlsLnN1YmplY3QgPSB0aGlzLmdldE1lcmdlVGFnVmFsdWUoJ2VtYWlsX3N1YmplY3QnLCBmb3JtVmFsdWVzKVxuICAgIHZpZGVvbWFpbC5ib2R5ID0gdGhpcy5nZXRNZXJnZVRhZ1ZhbHVlKCdlbWFpbF9ib2R5JywgZm9ybVZhbHVlcylcblxuICAgIGNiKG51bGwsIHZpZGVvbWFpbClcbiAgfSxcblxuICBvbkJlZm9yZURlc3Ryb3k6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnZpZGVvbWFpbENsaWVudC51bmxvYWQoKVxuICAgIGRlbGV0ZSB0aGlzLnZpZGVvbWFpbENsaWVudFxuICB9XG59KVxuXG5qUXVlcnkoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIG5ldyBWaWRlb21haWxGaWVsZENvbnRyb2xsZXIoKVxufSlcbiJdfQ==
