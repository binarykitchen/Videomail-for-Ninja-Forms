var DEBUG=!1,VideomailFieldController=Marionette.Object.extend({videomailClient:null,fieldModel:null,initialize:function(){Backbone.Radio.DEBUG=DEBUG,this.listenTo(Backbone.Radio.channel("videomail"),"init:model",this.registerVideomailField)},getFormId:function(){return this.fieldModel.get("formID")},registerVideomailField:function(e){this.videomailClient||(this.fieldModel=e,this.loadVideomailClient(),Backbone.Radio.channel("videomail").reply("validate:required",this.validateRequired,this),Backbone.Radio.channel("videomail").reply("validate:modelData",this.validateVideomail,this),Backbone.Radio.channel("form-"+this.getFormId()).reply("maybe:submit",this.maybeSubmit,this,e))},loadVideomailClient:function(){this.videomailClient=new VideomailClient({siteName:this.fieldModel.get("site_name"),video:{limitSeconds:this.fieldModel.get("limit_seconds")||90,width:this.fieldModel.get("width")||320,countdown:this.fieldModel.get("countdown")||!1},audio:{enabled:this.fieldModel.get("audio_enabled")||!1},selectors:{submitButtonSelector:".submit-wrap input"},callbacks:{adjustFormDataBeforePosting:this.adjustFormDataBeforePostingToVideomailServer.bind(this)},enableAutoValidation:!1,verbose:this.fieldModel.get("verbose")||DEBUG}),this.videomailClient.on(this.videomailClient.events.PREVIEW,this.onPreview.bind(this)),this.videomailClient.on(this.videomailClient.events.SUBMITTED,this.onSubmitted.bind(this)),this.videomailClient.on(this.videomailClient.events.GOING_BACK,this.onGoingBack.bind(this)),this.videomailClient.show()},onPreview:function(e){this.fieldModel.set("videomail-key",e),Backbone.Radio.channel("fields").request("remove:error",this.fieldModel.get("id"),"required-error")},onSubmitted:function(e){var i=nfRadio.channel("app").request("get:form",this.getFormId());nfRadio.channel("form-"+i.get("id")).request("add:extra","videomail",e),nfRadio.channel("form-"+this.getFormId()).request("submit",i)},onGoingBack:function(){this.fieldModel.set("videomail-key",null),this.invalidate()},validateRequired:function(e,i){var t=this.validateVideomail(i);return t||this.invalidate(),t},invalidate:function(){Backbone.Radio.channel("fields").request("add:error",this.fieldModel.get("id"),"required-error","Record and click on stop to see a preview video.")},validateVideomail:function(e){return e.get("videomail-key")||!1},hasErrors:function(e){return e.get("errors").length>0},maybeSubmit:function(e){return!(!e.getExtra("videomail")&&!this.hasErrors(e))||(this.videomailClient.submit(),!1)},getMergeTagValue:function(e,i){var t=this.fieldModel.get(e);if(t)if("{wp:admin_email}"===t)t=window.nfVideomail.admin_email;else{var o=t.replace("{field:","").replace("}","");o!==t&&(t=i[o])}return t},getFormValues:function(){return Backbone.Radio.channel("app").request("get:form",this.getFormId()).get("fields").reduce(function(e,i){return e[i.get("key")]=i.get("value"),e},{})},adjustFormDataBeforePostingToVideomailServer:function(e,i){var t=this.getFormValues();e.from=this.getMergeTagValue("email_from",t),e.to=this.getMergeTagValue("email_to",t),e.subject=this.getMergeTagValue("email_subject",t),e.body=this.getMergeTagValue("email_body",t),i(null,e)},onBeforeDestroy:function(){this.videomailClient.unload(),delete this.videomailClient}});jQuery(document).ready(function(){return new VideomailFieldController});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsiREVCVUciLCJWaWRlb21haWxGaWVsZENvbnRyb2xsZXIiLCJNYXJpb25ldHRlIiwiT2JqZWN0IiwiZXh0ZW5kIiwidmlkZW9tYWlsQ2xpZW50IiwiZmllbGRNb2RlbCIsImluaXRpYWxpemUiLCJCYWNrYm9uZSIsIlJhZGlvIiwidGhpcyIsImxpc3RlblRvIiwiY2hhbm5lbCIsInJlZ2lzdGVyVmlkZW9tYWlsRmllbGQiLCJnZXRGb3JtSWQiLCJnZXQiLCJsb2FkVmlkZW9tYWlsQ2xpZW50IiwicmVwbHkiLCJ2YWxpZGF0ZVJlcXVpcmVkIiwidmFsaWRhdGVWaWRlb21haWwiLCJtYXliZVN1Ym1pdCIsIlZpZGVvbWFpbENsaWVudCIsInNpdGVOYW1lIiwidmlkZW8iLCJsaW1pdFNlY29uZHMiLCJ3aWR0aCIsImNvdW50ZG93biIsImF1ZGlvIiwiZW5hYmxlZCIsInNlbGVjdG9ycyIsInN1Ym1pdEJ1dHRvblNlbGVjdG9yIiwiY2FsbGJhY2tzIiwiYWRqdXN0Rm9ybURhdGFCZWZvcmVQb3N0aW5nIiwiYWRqdXN0Rm9ybURhdGFCZWZvcmVQb3N0aW5nVG9WaWRlb21haWxTZXJ2ZXIiLCJiaW5kIiwiZW5hYmxlQXV0b1ZhbGlkYXRpb24iLCJ2ZXJib3NlIiwib24iLCJldmVudHMiLCJQUkVWSUVXIiwib25QcmV2aWV3IiwiU1VCTUlUVEVEIiwib25TdWJtaXR0ZWQiLCJHT0lOR19CQUNLIiwib25Hb2luZ0JhY2siLCJzaG93Iiwia2V5Iiwic2V0IiwicmVxdWVzdCIsInZpZGVvbWFpbCIsImZvcm1Nb2RlbCIsIm5mUmFkaW8iLCJpbnZhbGlkYXRlIiwiZWwiLCJ2YWxpZCIsImhhc0Vycm9ycyIsImxlbmd0aCIsImdldEV4dHJhIiwic3VibWl0IiwiZ2V0TWVyZ2VUYWdWYWx1ZSIsImZpZWxkS2V5IiwiZm9ybVZhbHVlcyIsInZhbHVlIiwid2luZG93IiwibmZWaWRlb21haWwiLCJhZG1pbl9lbWFpbCIsInJhd0ZpZWxkS2V5IiwicmVwbGFjZSIsImdldEZvcm1WYWx1ZXMiLCJyZWR1Y2UiLCJtZW1vIiwiZmllbGQiLCJjYiIsImZyb20iLCJ0byIsInN1YmplY3QiLCJib2R5Iiwib25CZWZvcmVEZXN0cm95IiwidW5sb2FkIiwialF1ZXJ5IiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6IkFBQ0EsSUFBSUEsT0FBUSxFQUtSQyx5QkFBMkJDLFdBQVdDLE9BQU9DLFFBRS9DQyxnQkFBaUIsS0FHakJDLFdBQVksS0FFWkMsV0FBWSxXQUNWQyxTQUFTQyxNQUFNVCxNQUFRQSxNQUV2QlUsS0FBS0MsU0FDSEgsU0FBU0MsTUFBTUcsUUFBUSxhQUN2QixhQUNBRixLQUFLRyx5QkFJVEMsVUFBVyxXQUNULE9BQU9KLEtBQUtKLFdBQVdTLElBQUksV0FHN0JGLHVCQUF3QixTQUFVUCxHQUczQkksS0FBS0wsa0JBQ1JLLEtBQUtKLFdBQWFBLEVBRWxCSSxLQUFLTSxzQkFJTFIsU0FBU0MsTUFBTUcsUUFBUSxhQUFhSyxNQUNsQyxvQkFDQVAsS0FBS1EsaUJBQ0xSLE1BR0ZGLFNBQVNDLE1BQU1HLFFBQVEsYUFBYUssTUFDbEMscUJBQ0FQLEtBQUtTLGtCQUNMVCxNQUtGRixTQUFTQyxNQUFNRyxRQUFRLFFBQVVGLEtBQUtJLGFBQWFHLE1BQ2pELGVBQ0FQLEtBQUtVLFlBQ0xWLEtBQ0FKLEtBS05VLG9CQUFxQixXQUNuQk4sS0FBS0wsZ0JBQWtCLElBQUlnQixpQkFDekJDLFNBQVVaLEtBQUtKLFdBQVdTLElBQUksYUFDOUJRLE9BQ0VDLGFBQWNkLEtBQUtKLFdBQVdTLElBQUksa0JBQW9CLEdBQ3REVSxNQUFPZixLQUFLSixXQUFXUyxJQUFJLFVBQVksSUFDdkNXLFVBQVdoQixLQUFLSixXQUFXUyxJQUFJLGVBQWdCLEdBRWpEWSxPQUNFQyxRQUFTbEIsS0FBS0osV0FBV1MsSUFBSSxtQkFBb0IsR0FFbkRjLFdBQ0VDLHFCQUFzQixzQkFFeEJDLFdBRUVDLDRCQUE2QnRCLEtBQUt1Qiw2Q0FBNkNDLEtBQUt4QixPQUd0RnlC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c3dpdGNoIHRvIGhhdmUgbW9yZSBzdHVmZiBwcmludGVkIHRvIGNvbnNvbGVcbnZhciBERUJVRyA9IGZhbHNlXG5cbi8vIGdvb2QgZG9jdW1lbnRhdGlvbiBvbiBiYWNrYm9uZSBldmVudCBoYW5kbGluZ1xuLy8gaHR0cDovL2JhY2tib25lanMub3JnLyNFdmVudHNcblxudmFyIFZpZGVvbWFpbEZpZWxkQ29udHJvbGxlciA9IE1hcmlvbmV0dGUuT2JqZWN0LmV4dGVuZCh7XG5cbiAgdmlkZW9tYWlsQ2xpZW50OiBudWxsLFxuXG4gIC8vIG5vdCBzdXJlIGlmIHRoaXMgaXMgYSBnb29kIGlkZWEsIGJ1dCBpIG5lZWQgYSByZWZlcmVuY2UgdG8gaXRcbiAgZmllbGRNb2RlbDogbnVsbCxcblxuICBpbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7XG4gICAgQmFja2JvbmUuUmFkaW8uREVCVUcgPSBERUJVR1xuXG4gICAgdGhpcy5saXN0ZW5UbyhcbiAgICAgIEJhY2tib25lLlJhZGlvLmNoYW5uZWwoJ3ZpZGVvbWFpbCcpLFxuICAgICAgJ2luaXQ6bW9kZWwnLFxuICAgICAgdGhpcy5yZWdpc3RlclZpZGVvbWFpbEZpZWxkXG4gICAgKVxuICB9LFxuXG4gIGdldEZvcm1JZDogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdmb3JtSUQnKVxuICB9LFxuXG4gIHJlZ2lzdGVyVmlkZW9tYWlsRmllbGQ6IGZ1bmN0aW9uIChmaWVsZE1vZGVsKSB7XG4gICAgLy8gd29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL3dwbmluamFzL25pbmphLWZvcm1zL2lzc3Vlcy8yNjc1XG4gICAgLy8gYWxzbyBwcmV2ZW50cyBmcm9tIGV2ZW50IGVtaXR0ZXIgbGVha3MgdW5kZXIgcmFjZSBjb25kaXRpb25zXG4gICAgaWYgKCF0aGlzLnZpZGVvbWFpbENsaWVudCkge1xuICAgICAgdGhpcy5maWVsZE1vZGVsID0gZmllbGRNb2RlbFxuXG4gICAgICB0aGlzLmxvYWRWaWRlb21haWxDbGllbnQoKVxuXG4gICAgICAvLyBjdXN0b20gZmllbGQgdmFsaWRhdGlvbiwgc2luY2Ugd2UgYXJlbid0IHVzaW5nIGEgc3RhbmRhcmQgYHZhbHVlYFxuICAgICAgLy8gZm9yIHRoZSB2aWRlb21haWwgaW5wdXRcbiAgICAgIEJhY2tib25lLlJhZGlvLmNoYW5uZWwoJ3ZpZGVvbWFpbCcpLnJlcGx5KFxuICAgICAgICAndmFsaWRhdGU6cmVxdWlyZWQnLFxuICAgICAgICB0aGlzLnZhbGlkYXRlUmVxdWlyZWQsXG4gICAgICAgIHRoaXNcbiAgICAgIClcblxuICAgICAgQmFja2JvbmUuUmFkaW8uY2hhbm5lbCgndmlkZW9tYWlsJykucmVwbHkoXG4gICAgICAgICd2YWxpZGF0ZTptb2RlbERhdGEnLFxuICAgICAgICB0aGlzLnZhbGlkYXRlVmlkZW9tYWlsLFxuICAgICAgICB0aGlzXG4gICAgICApXG5cbiAgICAgIC8vIGNvbnRyb2wgc3VibWlzc2lvbiBwcm9ncmVzcyxcbiAgICAgIC8vIHNvIHRoYXQgd2UgY2FuIFBPU1QgdG8gdGhlIFZpZGVvbWFpbCBzZXJ2ZXIgZmlyc3RcbiAgICAgIEJhY2tib25lLlJhZGlvLmNoYW5uZWwoJ2Zvcm0tJyArIHRoaXMuZ2V0Rm9ybUlkKCkpLnJlcGx5KFxuICAgICAgICAnbWF5YmU6c3VibWl0JyxcbiAgICAgICAgdGhpcy5tYXliZVN1Ym1pdCxcbiAgICAgICAgdGhpcyxcbiAgICAgICAgZmllbGRNb2RlbFxuICAgICAgKVxuICAgIH1cbiAgfSxcblxuICBsb2FkVmlkZW9tYWlsQ2xpZW50OiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy52aWRlb21haWxDbGllbnQgPSBuZXcgVmlkZW9tYWlsQ2xpZW50KHtcbiAgICAgIHNpdGVOYW1lOiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdzaXRlX25hbWUnKSxcbiAgICAgIHZpZGVvOiB7XG4gICAgICAgIGxpbWl0U2Vjb25kczogdGhpcy5maWVsZE1vZGVsLmdldCgnbGltaXRfc2Vjb25kcycpIHx8IDkwLFxuICAgICAgICB3aWR0aDogdGhpcy5maWVsZE1vZGVsLmdldCgnd2lkdGgnKSB8fCAzMjAsXG4gICAgICAgIGNvdW50ZG93bjogdGhpcy5maWVsZE1vZGVsLmdldCgnY291bnRkb3duJykgfHwgZmFsc2VcbiAgICAgIH0sXG4gICAgICBhdWRpbzoge1xuICAgICAgICBlbmFibGVkOiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdhdWRpb19lbmFibGVkJykgfHwgZmFsc2VcbiAgICAgIH0sXG4gICAgICBzZWxlY3RvcnM6IHtcbiAgICAgICAgc3VibWl0QnV0dG9uU2VsZWN0b3I6ICcuc3VibWl0LXdyYXAgaW5wdXQnXG4gICAgICB9LFxuICAgICAgY2FsbGJhY2tzOiB7XG4gICAgICAgIC8vIHVnbHkgbmFtZSBlaD9cbiAgICAgICAgYWRqdXN0Rm9ybURhdGFCZWZvcmVQb3N0aW5nOiB0aGlzLmFkanVzdEZvcm1EYXRhQmVmb3JlUG9zdGluZ1RvVmlkZW9tYWlsU2VydmVyLmJpbmQodGhpcylcbiAgICAgIH0sXG4gICAgICAvLyBsZWF2ZSBpdCB0byBuaW5qYSBmb3JtIHRvIHZhbGlkYXRlIHRoZSBpbnB1dHNcbiAgICAgIGVuYWJsZUF1dG9WYWxpZGF0aW9uOiBmYWxzZSxcbiAgICAgIC8vIGxvZyBhY3Rpb25zL2V2ZW50cyB0byBjb25zb2xlXG4gICAgICB2ZXJib3NlOiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCd2ZXJib3NlJykgfHwgREVCVUdcbiAgICB9KVxuXG4gICAgdGhpcy52aWRlb21haWxDbGllbnQub24odGhpcy52aWRlb21haWxDbGllbnQuZXZlbnRzLlBSRVZJRVcsIHRoaXMub25QcmV2aWV3LmJpbmQodGhpcykpXG4gICAgdGhpcy52aWRlb21haWxDbGllbnQub24odGhpcy52aWRlb21haWxDbGllbnQuZXZlbnRzLlNVQk1JVFRFRCwgdGhpcy5vblN1Ym1pdHRlZC5iaW5kKHRoaXMpKVxuICAgIHRoaXMudmlkZW9tYWlsQ2xpZW50Lm9uKHRoaXMudmlkZW9tYWlsQ2xpZW50LmV2ZW50cy5HT0lOR19CQUNLLCB0aGlzLm9uR29pbmdCYWNrLmJpbmQodGhpcykpXG5cbiAgICB0aGlzLnZpZGVvbWFpbENsaWVudC5zaG93KClcbiAgfSxcblxuICAvLyBuZWVkZWQgdG8gZ2V0IHRoZSB2aWRlb21haWwga2V5IHdoaWNoIGlzIHJlcXVpcmVkIGJlZm9yZVxuICAvLyBzdWJtaXR0aW5nIHRvIHRoZSB2aWRlb21haWwgc2VydmVyXG4gIG9uUHJldmlldzogZnVuY3Rpb24gKGtleSkge1xuICAgIHRoaXMuZmllbGRNb2RlbC5zZXQoJ3ZpZGVvbWFpbC1rZXknLCBrZXkpXG4gICAgQmFja2JvbmUuUmFkaW9cbiAgICAgIC5jaGFubmVsKCdmaWVsZHMnKVxuICAgICAgLy8gY2xlYXJzIGFueSBwcmV2aW91cyBlcnJvcnNcbiAgICAgIC5yZXF1ZXN0KCdyZW1vdmU6ZXJyb3InLCB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdpZCcpLCAncmVxdWlyZWQtZXJyb3InKVxuICB9LFxuXG4gIG9uU3VibWl0dGVkOiBmdW5jdGlvbiAodmlkZW9tYWlsKSB7XG4gICAgdmFyIGZvcm1Nb2RlbCA9IG5mUmFkaW8uY2hhbm5lbCgnYXBwJykucmVxdWVzdCgnZ2V0OmZvcm0nLCB0aGlzLmdldEZvcm1JZCgpKVxuXG4gICAgLy8gdG9kbyBpc250ICdmb3JtLScgKyBmb3JtTW9kZWwuZ2V0KCdpZCcpIHRoZSBzYW1lIGFzIHRoZSBmb3JtSUQgYWxyZWFkeT9cbiAgICBuZlJhZGlvLmNoYW5uZWwoJ2Zvcm0tJyArIGZvcm1Nb2RlbC5nZXQoJ2lkJykpLnJlcXVlc3QoJ2FkZDpleHRyYScsICd2aWRlb21haWwnLCB2aWRlb21haWwpXG5cbiAgICAvLyByZXN0YXJ0IHN1Ym1pc3Npb24gYWdhaW4sIHRoaXMgdGltZSB0byB0aGUgcmVhbCB3cCBzaXRlXG4gICAgbmZSYWRpby5jaGFubmVsKCdmb3JtLScgKyB0aGlzLmdldEZvcm1JZCgpKS5yZXF1ZXN0KCdzdWJtaXQnLCBmb3JtTW9kZWwpXG4gIH0sXG5cbiAgb25Hb2luZ0JhY2s6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmZpZWxkTW9kZWwuc2V0KCd2aWRlb21haWwta2V5JywgbnVsbClcbiAgICB0aGlzLmludmFsaWRhdGUoKVxuICB9LFxuXG4gIHZhbGlkYXRlUmVxdWlyZWQ6IGZ1bmN0aW9uIChlbCwgZmllbGRNb2RlbCkge1xuICAgIHZhciB2YWxpZCA9IHRoaXMudmFsaWRhdGVWaWRlb21haWwoZmllbGRNb2RlbClcblxuICAgIGlmICghdmFsaWQpIHtcbiAgICAgIHRoaXMuaW52YWxpZGF0ZSgpXG4gICAgfVxuXG4gICAgcmV0dXJuIHZhbGlkXG4gIH0sXG5cbiAgaW52YWxpZGF0ZTogZnVuY3Rpb24gKCkge1xuICAgIC8vIG92ZXJyaWRlIGRlZmF1bHQgYmVoYXZpb3VyIHNvIHRoYXQgd2UgY2FuIHNldCBvdXIgb3duIGVycm9yIHRleHQgaGVyZVxuICAgIEJhY2tib25lLlJhZGlvLmNoYW5uZWwoJ2ZpZWxkcycpLnJlcXVlc3QoXG4gICAgICAnYWRkOmVycm9yJyxcbiAgICAgIHRoaXMuZmllbGRNb2RlbC5nZXQoJ2lkJyksXG4gICAgICAncmVxdWlyZWQtZXJyb3InLFxuICAgICAgJ1JlY29yZCBhbmQgY2xpY2sgb24gc3RvcCB0byBzZWUgYSBwcmV2aWV3IHZpZGVvLidcbiAgICApXG4gIH0sXG5cbiAgdmFsaWRhdGVWaWRlb21haWw6IGZ1bmN0aW9uIChmaWVsZE1vZGVsKSB7XG4gICAgcmV0dXJuIGZpZWxkTW9kZWwuZ2V0KCd2aWRlb21haWwta2V5JykgfHwgZmFsc2VcbiAgfSxcblxuICBoYXNFcnJvcnM6IGZ1bmN0aW9uIChmb3JtTW9kZWwpIHtcbiAgICByZXR1cm4gZm9ybU1vZGVsLmdldCgnZXJyb3JzJykubGVuZ3RoID4gMFxuICB9LFxuXG4gIG1heWJlU3VibWl0OiBmdW5jdGlvbiAoZm9ybU1vZGVsKSB7XG4gICAgLy8gb25seSB3aGVuIGEgdmlkZW9tYWlsIGhhcyBiZWVuIHJlY29yZGVkIGFuZCBubyBvdGhlciBmb3JtIGVycm9yc1xuICAgIC8vIGV4aXN0LCBzdWJtaXQgdGhlIGZpbmFsIHZpZGVvIHRvIHRoZSB2aWRlb21haWwgc2VydmVyXG4gICAgaWYgKCFmb3JtTW9kZWwuZ2V0RXh0cmEoJ3ZpZGVvbWFpbCcpICYmICF0aGlzLmhhc0Vycm9ycyhmb3JtTW9kZWwpKSB7XG4gICAgICB0aGlzLnZpZGVvbWFpbENsaWVudC5zdWJtaXQoKVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICB9LFxuXG4gIGdldE1lcmdlVGFnVmFsdWU6IGZ1bmN0aW9uIChmaWVsZEtleSwgZm9ybVZhbHVlcykge1xuICAgIHZhciB2YWx1ZSA9IHRoaXMuZmllbGRNb2RlbC5nZXQoZmllbGRLZXkpXG5cbiAgICAvLyBpdCBjYW4gaGFwcGVuIHRoYXQgdGhlIHVzZXIgaGFzIGNvbmZpZ3VyZWQgc29tZXRoaW5nIHdyb25nLFxuICAgIC8vIGkuRS4gYW4gZW1wdHkgZW1haWxfZnJvbS4gaW4gdGhhdCBjYXNlIGp1c3QgaWdub3JlIC4uLlxuICAgIGlmICh2YWx1ZSkge1xuICAgICAgLy8gYWRtaW4gZW1haWwgbG9jYWxpemVkIGZyb20gYmFja2VuZCwgYSBiaXQgdWdseVxuICAgICAgLy8gdG9kbyBhc2sgZm9yIGFuIGVuZHBvaW50IHRvIHByb2Nlc3MgdGhvc2Ugc3BlY2lhbCBtZXJnZSB0YWdzXG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vd3BuaW5qYXMvbmluamEtZm9ybXMtdmlkZW9tYWlsL2lzc3Vlcy8zMFxuICAgICAgaWYgKHZhbHVlID09PSAne3dwOmFkbWluX2VtYWlsfScpIHtcbiAgICAgICAgdmFsdWUgPSB3aW5kb3cubmZWaWRlb21haWwuYWRtaW5fZW1haWxcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciByYXdGaWVsZEtleSA9IHZhbHVlLnJlcGxhY2UoJ3tmaWVsZDonLCAnJykucmVwbGFjZSgnfScsICcnKVxuXG4gICAgICAgIGlmIChyYXdGaWVsZEtleSAhPT0gdmFsdWUpIHtcbiAgICAgICAgICAvLyB5ZXMgaXQgd2FzIGEgbWVyZ2UgdGFnLCBzbyB1c2UgaXRcbiAgICAgICAgICB2YWx1ZSA9IGZvcm1WYWx1ZXNbcmF3RmllbGRLZXldXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdmFsdWVcbiAgfSxcblxuICBnZXRGb3JtVmFsdWVzOiBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGZvcm1Nb2RlbCA9IEJhY2tib25lLlJhZGlvLmNoYW5uZWwoJ2FwcCcpLnJlcXVlc3QoJ2dldDpmb3JtJywgdGhpcy5nZXRGb3JtSWQoKSlcbiAgICB2YXIgZmllbGRzQ29sbGVjdGlvbiA9IGZvcm1Nb2RlbC5nZXQoJ2ZpZWxkcycpXG5cbiAgICByZXR1cm4gZmllbGRzQ29sbGVjdGlvbi5yZWR1Y2UoZnVuY3Rpb24gKG1lbW8sIGZpZWxkKSB7XG4gICAgICBtZW1vW2ZpZWxkLmdldCgna2V5JyldID0gZmllbGQuZ2V0KCd2YWx1ZScpXG4gICAgICByZXR1cm4gbWVtb1xuICAgIH0sIHt9KVxuICB9LFxuXG4gIGFkanVzdEZvcm1EYXRhQmVmb3JlUG9zdGluZ1RvVmlkZW9tYWlsU2VydmVyOiBmdW5jdGlvbiAodmlkZW9tYWlsLCBjYikge1xuICAgIHZhciBmb3JtVmFsdWVzID0gdGhpcy5nZXRGb3JtVmFsdWVzKClcblxuICAgIHZpZGVvbWFpbC5mcm9tID0gdGhpcy5nZXRNZXJnZVRhZ1ZhbHVlKCdlbWFpbF9mcm9tJywgZm9ybVZhbHVlcylcbiAgICB2aWRlb21haWwudG8gPSB0aGlzLmdldE1lcmdlVGFnVmFsdWUoJ2VtYWlsX3RvJywgZm9ybVZhbHVlcylcbiAgICB2aWRlb21haWwuc3ViamVjdCA9IHRoaXMuZ2V0TWVyZ2VUYWdWYWx1ZSgnZW1haWxfc3ViamVjdCcsIGZvcm1WYWx1ZXMpXG4gICAgdmlkZW9tYWlsLmJvZHkgPSB0aGlzLmdldE1lcmdlVGFnVmFsdWUoJ2VtYWlsX2JvZHknLCBmb3JtVmFsdWVzKVxuXG4gICAgY2IobnVsbCwgdmlkZW9tYWlsKVxuICB9LFxuXG4gIG9uQmVmb3JlRGVzdHJveTogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMudmlkZW9tYWlsQ2xpZW50LnVubG9hZCgpXG4gICAgZGVsZXRlIHRoaXMudmlkZW9tYWlsQ2xpZW50XG4gIH1cbn0pXG5cbmpRdWVyeShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24gKCkge1xuICByZXR1cm4gbmV3IFZpZGVvbWFpbEZpZWxkQ29udHJvbGxlcigpXG59KVxuIl19
