var DEBUG=!0,VideomailFieldController=Marionette.Object.extend({videomailClient:null,fieldModel:null,initialize:function(){Backbone.Radio.DEBUG=DEBUG,this.listenTo(Backbone.Radio.channel("videomail"),"init:model",this.registerVideomailField)},getFormId:function(){return this.fieldModel.get("formID")},registerVideomailField:function(e){this.videomailClient||(this.fieldModel=e,this.loadVideomailClient(),Backbone.Radio.channel("videomail").reply("validate:required",this.validateRequired,this),Backbone.Radio.channel("videomail").reply("validate:modelData",this.validateVideomail,this),Backbone.Radio.channel("form-"+this.getFormId()).reply("maybe:submit",this.maybeSubmit,this,e))},loadVideomailClient:function(){this.videomailClient=new VideomailClient({siteName:this.fieldModel.get("site_name"),video:{limitSeconds:this.fieldModel.get("limit_seconds")||90,width:this.fieldModel.get("width")||320,countdown:this.fieldModel.get("countdown")||!1},audio:{enabled:this.fieldModel.get("audio_enabled")||!1},selectors:{submitButtonSelector:".submit-wrap input"},callbacks:{adjustFormDataBeforePosting:this.adjustFormDataBeforePostingToVideomailServer.bind(this)},enableAutoValidation:!1,verbose:this.fieldModel.get("verbose")||DEBUG}),this.videomailClient.on(this.videomailClient.events.PREVIEW,this.onPreview.bind(this)),this.videomailClient.on(this.videomailClient.events.SUBMITTED,this.onSubmitted.bind(this)),this.videomailClient.on(this.videomailClient.events.GOING_BACK,this.onGoingBack.bind(this)),this.videomailClient.show()},onPreview:function(e){this.fieldModel.set("videomail-key",e),Backbone.Radio.channel("fields").request("remove:error",this.fieldModel.get("id"),"required-error")},onSubmitted:function(e){var i=nfRadio.channel("app").request("get:form",this.getFormId());nfRadio.channel("form-"+i.get("id")).request("add:extra","videomail",e),nfRadio.channel("form-"+this.getFormId()).request("submit",i)},onGoingBack:function(){this.fieldModel.set("videomail-key",null),this.invalidate()},validateRequired:function(e,i){var t=this.validateVideomail(i);return t||this.invalidate(),t},invalidate:function(){Backbone.Radio.channel("fields").request("add:error",this.fieldModel.get("id"),"required-error","Record and click on stop to see a preview video.")},validateVideomail:function(e){return e.get("videomail-key")||!1},hasErrors:function(e){return e.get("errors").length>0},maybeSubmit:function(e){return!(!e.getExtra("videomail")&&!this.hasErrors(e))||(this.videomailClient.submit(),!1)},getMergeTagValue:function(e,i){var t=this.fieldModel.get(e);if(t)if("{wp:admin_email}"===t)t=window.nfVideomail.admin_email;else{var o=t.replace("{field:","").replace("}","");o!==t&&(t=i[o])}return t},getFormValues:function(){return Backbone.Radio.channel("app").request("get:form",this.getFormId()).get("fields").reduce(function(e,i){return e[i.get("key")]=i.get("value"),e},{})},adjustFormDataBeforePostingToVideomailServer:function(e,i){var t=this.getFormValues();e.from=this.getMergeTagValue("email_from",t),e.to=this.getMergeTagValue("email_to",t),e.subject=this.getMergeTagValue("email_subject",t),e.body=this.getMergeTagValue("email_body",t),i(null,e)},onBeforeDestroy:function(){this.videomailClient.unload(),delete this.videomailClient}});jQuery(document).ready(function(){return new VideomailFieldController});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsiREVCVUciLCJWaWRlb21haWxGaWVsZENvbnRyb2xsZXIiLCJNYXJpb25ldHRlIiwiT2JqZWN0IiwiZXh0ZW5kIiwidmlkZW9tYWlsQ2xpZW50IiwiZmllbGRNb2RlbCIsImluaXRpYWxpemUiLCJCYWNrYm9uZSIsIlJhZGlvIiwidGhpcyIsImxpc3RlblRvIiwiY2hhbm5lbCIsInJlZ2lzdGVyVmlkZW9tYWlsRmllbGQiLCJnZXRGb3JtSWQiLCJnZXQiLCJsb2FkVmlkZW9tYWlsQ2xpZW50IiwicmVwbHkiLCJ2YWxpZGF0ZVJlcXVpcmVkIiwidmFsaWRhdGVWaWRlb21haWwiLCJtYXliZVN1Ym1pdCIsIlZpZGVvbWFpbENsaWVudCIsInNpdGVOYW1lIiwidmlkZW8iLCJsaW1pdFNlY29uZHMiLCJ3aWR0aCIsImNvdW50ZG93biIsImF1ZGlvIiwiZW5hYmxlZCIsInNlbGVjdG9ycyIsInN1Ym1pdEJ1dHRvblNlbGVjdG9yIiwiY2FsbGJhY2tzIiwiYWRqdXN0Rm9ybURhdGFCZWZvcmVQb3N0aW5nIiwiYWRqdXN0Rm9ybURhdGFCZWZvcmVQb3N0aW5nVG9WaWRlb21haWxTZXJ2ZXIiLCJiaW5kIiwiZW5hYmxlQXV0b1ZhbGlkYXRpb24iLCJ2ZXJib3NlIiwib24iLCJldmVudHMiLCJQUkVWSUVXIiwib25QcmV2aWV3IiwiU1VCTUlUVEVEIiwib25TdWJtaXR0ZWQiLCJHT0lOR19CQUNLIiwib25Hb2luZ0JhY2siLCJzaG93Iiwia2V5Iiwic2V0IiwicmVxdWVzdCIsInZpZGVvbWFpbCIsImZvcm1Nb2RlbCIsIm5mUmFkaW8iLCJpbnZhbGlkYXRlIiwiZWwiLCJ2YWxpZCIsImhhc0Vycm9ycyIsImxlbmd0aCIsImdldEV4dHJhIiwic3VibWl0IiwiZ2V0TWVyZ2VUYWdWYWx1ZSIsImZpZWxkS2V5IiwiZm9ybVZhbHVlcyIsInZhbHVlIiwid2luZG93IiwibmZWaWRlb21haWwiLCJhZG1pbl9lbWFpbCIsInJhd0ZpZWxkS2V5IiwicmVwbGFjZSIsImdldEZvcm1WYWx1ZXMiLCJyZWR1Y2UiLCJtZW1vIiwiZmllbGQiLCJjYiIsImZyb20iLCJ0byIsInN1YmplY3QiLCJib2R5Iiwib25CZWZvcmVEZXN0cm95IiwidW5sb2FkIiwialF1ZXJ5IiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6IkFBQ0EsSUFBSUEsT0FBUSxFQUtSQyx5QkFBMkJDLFdBQVdDLE9BQU9DLFFBRS9DQyxnQkFBaUIsS0FHakJDLFdBQVksS0FFWkMsV0FBWSxXQUNWQyxTQUFTQyxNQUFNVCxNQUFRQSxNQUV2QlUsS0FBS0MsU0FDSEgsU0FBU0MsTUFBTUcsUUFBUSxhQUN2QixhQUNBRixLQUFLRyx5QkFJVEMsVUFBVyxXQUNULE9BQU9KLEtBQUtKLFdBQVdTLElBQUksV0FHN0JGLHVCQUF3QixTQUFVUCxHQUczQkksS0FBS0wsa0JBQ1JLLEtBQUtKLFdBQWFBLEVBRWxCSSxLQUFLTSxzQkFJTFIsU0FBU0MsTUFBTUcsUUFBUSxhQUFhSyxNQUNsQyxvQkFDQVAsS0FBS1EsaUJBQ0xSLE1BR0ZGLFNBQVNDLE1BQU1HLFFBQVEsYUFBYUssTUFDbEMscUJBQ0FQLEtBQUtTLGtCQUNMVCxNQUtGRixTQUFTQyxNQUFNRyxRQUFRLFFBQVVGLEtBQUtJLGFBQWFHLE1BQ2pELGVBQ0FQLEtBQUtVLFlBQ0xWLEtBQ0FKLEtBS05VLG9CQUFxQixXQUNuQk4sS0FBS0wsZ0JBQWtCLElBQUlnQixpQkFDekJDLFNBQVVaLEtBQUtKLFdBQVdTLElBQUksYUFDOUJRLE9BQ0VDLGFBQWNkLEtBQUtKLFdBQVdTLElBQUksa0JBQW9CLEdBQ3REVSxNQUFPZixLQUFLSixXQUFXUyxJQUFJLFVBQVksSUFDdkNXLFVBQVdoQixLQUFLSixXQUFXUyxJQUFJLGVBQWdCLEdBRWpEWSxPQUNFQyxRQUFTbEIsS0FBS0osV0FBV1MsSUFBSSxtQkFBb0IsR0FFbkRjLFdBQ0VDLHFCQUFzQixzQkFFeEJDLFdBRUVDLDRCQUE2QnRCLEtBQUt1Qiw2Q0FBNkNDLEtBQUt4QixPQUd0RnlC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c3dpdGNoIHRvIGhhdmUgbW9yZSBzdHVmZiBwcmludGVkIHRvIGNvbnNvbGVcbnZhciBERUJVRyA9IHRydWVcblxuLy8gZ29vZCBkb2N1bWVudGF0aW9uIG9uIGJhY2tib25lIGV2ZW50IGhhbmRsaW5nXG4vLyBodHRwOi8vYmFja2JvbmVqcy5vcmcvI0V2ZW50c1xuXG52YXIgVmlkZW9tYWlsRmllbGRDb250cm9sbGVyID0gTWFyaW9uZXR0ZS5PYmplY3QuZXh0ZW5kKHtcblxuICB2aWRlb21haWxDbGllbnQ6IG51bGwsXG5cbiAgLy8gbm90IHN1cmUgaWYgdGhpcyBpcyBhIGdvb2QgaWRlYSwgYnV0IGkgbmVlZCBhIHJlZmVyZW5jZSB0byBpdFxuICBmaWVsZE1vZGVsOiBudWxsLFxuXG4gIGluaXRpYWxpemU6IGZ1bmN0aW9uICgpIHtcbiAgICBCYWNrYm9uZS5SYWRpby5ERUJVRyA9IERFQlVHXG5cbiAgICB0aGlzLmxpc3RlblRvKFxuICAgICAgQmFja2JvbmUuUmFkaW8uY2hhbm5lbCgndmlkZW9tYWlsJyksXG4gICAgICAnaW5pdDptb2RlbCcsXG4gICAgICB0aGlzLnJlZ2lzdGVyVmlkZW9tYWlsRmllbGRcbiAgICApXG4gIH0sXG5cbiAgZ2V0Rm9ybUlkOiBmdW5jdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuZmllbGRNb2RlbC5nZXQoJ2Zvcm1JRCcpXG4gIH0sXG5cbiAgcmVnaXN0ZXJWaWRlb21haWxGaWVsZDogZnVuY3Rpb24gKGZpZWxkTW9kZWwpIHtcbiAgICAvLyB3b3JrYXJvdW5kIGZvciBodHRwczovL2dpdGh1Yi5jb20vd3BuaW5qYXMvbmluamEtZm9ybXMvaXNzdWVzLzI2NzVcbiAgICAvLyBhbHNvIHByZXZlbnRzIGZyb20gZXZlbnQgZW1pdHRlciBsZWFrcyB1bmRlciByYWNlIGNvbmRpdGlvbnNcbiAgICBpZiAoIXRoaXMudmlkZW9tYWlsQ2xpZW50KSB7XG4gICAgICB0aGlzLmZpZWxkTW9kZWwgPSBmaWVsZE1vZGVsXG5cbiAgICAgIHRoaXMubG9hZFZpZGVvbWFpbENsaWVudCgpXG5cbiAgICAgIC8vIGN1c3RvbSBmaWVsZCB2YWxpZGF0aW9uLCBzaW5jZSB3ZSBhcmVuJ3QgdXNpbmcgYSBzdGFuZGFyZCBgdmFsdWVgXG4gICAgICAvLyBmb3IgdGhlIHZpZGVvbWFpbCBpbnB1dFxuICAgICAgQmFja2JvbmUuUmFkaW8uY2hhbm5lbCgndmlkZW9tYWlsJykucmVwbHkoXG4gICAgICAgICd2YWxpZGF0ZTpyZXF1aXJlZCcsXG4gICAgICAgIHRoaXMudmFsaWRhdGVSZXF1aXJlZCxcbiAgICAgICAgdGhpc1xuICAgICAgKVxuXG4gICAgICBCYWNrYm9uZS5SYWRpby5jaGFubmVsKCd2aWRlb21haWwnKS5yZXBseShcbiAgICAgICAgJ3ZhbGlkYXRlOm1vZGVsRGF0YScsXG4gICAgICAgIHRoaXMudmFsaWRhdGVWaWRlb21haWwsXG4gICAgICAgIHRoaXNcbiAgICAgIClcblxuICAgICAgLy8gY29udHJvbCBzdWJtaXNzaW9uIHByb2dyZXNzLFxuICAgICAgLy8gc28gdGhhdCB3ZSBjYW4gUE9TVCB0byB0aGUgVmlkZW9tYWlsIHNlcnZlciBmaXJzdFxuICAgICAgQmFja2JvbmUuUmFkaW8uY2hhbm5lbCgnZm9ybS0nICsgdGhpcy5nZXRGb3JtSWQoKSkucmVwbHkoXG4gICAgICAgICdtYXliZTpzdWJtaXQnLFxuICAgICAgICB0aGlzLm1heWJlU3VibWl0LFxuICAgICAgICB0aGlzLFxuICAgICAgICBmaWVsZE1vZGVsXG4gICAgICApXG4gICAgfVxuICB9LFxuXG4gIGxvYWRWaWRlb21haWxDbGllbnQ6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLnZpZGVvbWFpbENsaWVudCA9IG5ldyBWaWRlb21haWxDbGllbnQoe1xuICAgICAgc2l0ZU5hbWU6IHRoaXMuZmllbGRNb2RlbC5nZXQoJ3NpdGVfbmFtZScpLFxuICAgICAgdmlkZW86IHtcbiAgICAgICAgbGltaXRTZWNvbmRzOiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdsaW1pdF9zZWNvbmRzJykgfHwgOTAsXG4gICAgICAgIHdpZHRoOiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCd3aWR0aCcpIHx8IDMyMCxcbiAgICAgICAgY291bnRkb3duOiB0aGlzLmZpZWxkTW9kZWwuZ2V0KCdjb3VudGRvd24nKSB8fCBmYWxzZVxuICAgICAgfSxcbiAgICAgIGF1ZGlvOiB7XG4gICAgICAgIGVuYWJsZWQ6IHRoaXMuZmllbGRNb2RlbC5nZXQoJ2F1ZGlvX2VuYWJsZWQnKSB8fCBmYWxzZVxuICAgICAgfSxcbiAgICAgIHNlbGVjdG9yczoge1xuICAgICAgICBzdWJtaXRCdXR0b25TZWxlY3RvcjogJy5zdWJtaXQtd3JhcCBpbnB1dCdcbiAgICAgIH0sXG4gICAgICBjYWxsYmFja3M6IHtcbiAgICAgICAgLy8gdWdseSBuYW1lIGVoP1xuICAgICAgICBhZGp1c3RGb3JtRGF0YUJlZm9yZVBvc3Rpbmc6IHRoaXMuYWRqdXN0Rm9ybURhdGFCZWZvcmVQb3N0aW5nVG9WaWRlb21haWxTZXJ2ZXIuYmluZCh0aGlzKVxuICAgICAgfSxcbiAgICAgIC8vIGxlYXZlIGl0IHRvIG5pbmphIGZvcm0gdG8gdmFsaWRhdGUgdGhlIGlucHV0c1xuICAgICAgZW5hYmxlQXV0b1ZhbGlkYXRpb246IGZhbHNlLFxuICAgICAgLy8gbG9nIGFjdGlvbnMvZXZlbnRzIHRvIGNvbnNvbGVcbiAgICAgIHZlcmJvc2U6IHRoaXMuZmllbGRNb2RlbC5nZXQoJ3ZlcmJvc2UnKSB8fCBERUJVR1xuICAgIH0pXG5cbiAgICB0aGlzLnZpZGVvbWFpbENsaWVudC5vbih0aGlzLnZpZGVvbWFpbENsaWVudC5ldmVudHMuUFJFVklFVywgdGhpcy5vblByZXZpZXcuYmluZCh0aGlzKSlcbiAgICB0aGlzLnZpZGVvbWFpbENsaWVudC5vbih0aGlzLnZpZGVvbWFpbENsaWVudC5ldmVudHMuU1VCTUlUVEVELCB0aGlzLm9uU3VibWl0dGVkLmJpbmQodGhpcykpXG4gICAgdGhpcy52aWRlb21haWxDbGllbnQub24odGhpcy52aWRlb21haWxDbGllbnQuZXZlbnRzLkdPSU5HX0JBQ0ssIHRoaXMub25Hb2luZ0JhY2suYmluZCh0aGlzKSlcblxuICAgIHRoaXMudmlkZW9tYWlsQ2xpZW50LnNob3coKVxuICB9LFxuXG4gIC8vIG5lZWRlZCB0byBnZXQgdGhlIHZpZGVvbWFpbCBrZXkgd2hpY2ggaXMgcmVxdWlyZWQgYmVmb3JlXG4gIC8vIHN1Ym1pdHRpbmcgdG8gdGhlIHZpZGVvbWFpbCBzZXJ2ZXJcbiAgb25QcmV2aWV3OiBmdW5jdGlvbiAoa2V5KSB7XG4gICAgdGhpcy5maWVsZE1vZGVsLnNldCgndmlkZW9tYWlsLWtleScsIGtleSlcbiAgICBCYWNrYm9uZS5SYWRpb1xuICAgICAgLmNoYW5uZWwoJ2ZpZWxkcycpXG4gICAgICAvLyBjbGVhcnMgYW55IHByZXZpb3VzIGVycm9yc1xuICAgICAgLnJlcXVlc3QoJ3JlbW92ZTplcnJvcicsIHRoaXMuZmllbGRNb2RlbC5nZXQoJ2lkJyksICdyZXF1aXJlZC1lcnJvcicpXG4gIH0sXG5cbiAgb25TdWJtaXR0ZWQ6IGZ1bmN0aW9uICh2aWRlb21haWwpIHtcbiAgICB2YXIgZm9ybU1vZGVsID0gbmZSYWRpby5jaGFubmVsKCdhcHAnKS5yZXF1ZXN0KCdnZXQ6Zm9ybScsIHRoaXMuZ2V0Rm9ybUlkKCkpXG5cbiAgICAvLyB0b2RvIGlzbnQgJ2Zvcm0tJyArIGZvcm1Nb2RlbC5nZXQoJ2lkJykgdGhlIHNhbWUgYXMgdGhlIGZvcm1JRCBhbHJlYWR5P1xuICAgIG5mUmFkaW8uY2hhbm5lbCgnZm9ybS0nICsgZm9ybU1vZGVsLmdldCgnaWQnKSkucmVxdWVzdCgnYWRkOmV4dHJhJywgJ3ZpZGVvbWFpbCcsIHZpZGVvbWFpbClcblxuICAgIC8vIHJlc3RhcnQgc3VibWlzc2lvbiBhZ2FpbiwgdGhpcyB0aW1lIHRvIHRoZSByZWFsIHdwIHNpdGVcbiAgICBuZlJhZGlvLmNoYW5uZWwoJ2Zvcm0tJyArIHRoaXMuZ2V0Rm9ybUlkKCkpLnJlcXVlc3QoJ3N1Ym1pdCcsIGZvcm1Nb2RlbClcbiAgfSxcblxuICBvbkdvaW5nQmFjazogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuZmllbGRNb2RlbC5zZXQoJ3ZpZGVvbWFpbC1rZXknLCBudWxsKVxuICAgIHRoaXMuaW52YWxpZGF0ZSgpXG4gIH0sXG5cbiAgdmFsaWRhdGVSZXF1aXJlZDogZnVuY3Rpb24gKGVsLCBmaWVsZE1vZGVsKSB7XG4gICAgdmFyIHZhbGlkID0gdGhpcy52YWxpZGF0ZVZpZGVvbWFpbChmaWVsZE1vZGVsKVxuXG4gICAgaWYgKCF2YWxpZCkge1xuICAgICAgdGhpcy5pbnZhbGlkYXRlKClcbiAgICB9XG5cbiAgICByZXR1cm4gdmFsaWRcbiAgfSxcblxuICBpbnZhbGlkYXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgLy8gb3ZlcnJpZGUgZGVmYXVsdCBiZWhhdmlvdXIgc28gdGhhdCB3ZSBjYW4gc2V0IG91ciBvd24gZXJyb3IgdGV4dCBoZXJlXG4gICAgQmFja2JvbmUuUmFkaW8uY2hhbm5lbCgnZmllbGRzJykucmVxdWVzdChcbiAgICAgICdhZGQ6ZXJyb3InLFxuICAgICAgdGhpcy5maWVsZE1vZGVsLmdldCgnaWQnKSxcbiAgICAgICdyZXF1aXJlZC1lcnJvcicsXG4gICAgICAnUmVjb3JkIGFuZCBjbGljayBvbiBzdG9wIHRvIHNlZSBhIHByZXZpZXcgdmlkZW8uJ1xuICAgIClcbiAgfSxcblxuICB2YWxpZGF0ZVZpZGVvbWFpbDogZnVuY3Rpb24gKGZpZWxkTW9kZWwpIHtcbiAgICByZXR1cm4gZmllbGRNb2RlbC5nZXQoJ3ZpZGVvbWFpbC1rZXknKSB8fCBmYWxzZVxuICB9LFxuXG4gIGhhc0Vycm9yczogZnVuY3Rpb24gKGZvcm1Nb2RlbCkge1xuICAgIHJldHVybiBmb3JtTW9kZWwuZ2V0KCdlcnJvcnMnKS5sZW5ndGggPiAwXG4gIH0sXG5cbiAgbWF5YmVTdWJtaXQ6IGZ1bmN0aW9uIChmb3JtTW9kZWwpIHtcbiAgICAvLyBvbmx5IHdoZW4gYSB2aWRlb21haWwgaGFzIGJlZW4gcmVjb3JkZWQgYW5kIG5vIG90aGVyIGZvcm0gZXJyb3JzXG4gICAgLy8gZXhpc3QsIHN1Ym1pdCB0aGUgZmluYWwgdmlkZW8gdG8gdGhlIHZpZGVvbWFpbCBzZXJ2ZXJcbiAgICBpZiAoIWZvcm1Nb2RlbC5nZXRFeHRyYSgndmlkZW9tYWlsJykgJiYgIXRoaXMuaGFzRXJyb3JzKGZvcm1Nb2RlbCkpIHtcbiAgICAgIHRoaXMudmlkZW9tYWlsQ2xpZW50LnN1Ym1pdCgpXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG4gIH0sXG5cbiAgZ2V0TWVyZ2VUYWdWYWx1ZTogZnVuY3Rpb24gKGZpZWxkS2V5LCBmb3JtVmFsdWVzKSB7XG4gICAgdmFyIHZhbHVlID0gdGhpcy5maWVsZE1vZGVsLmdldChmaWVsZEtleSlcblxuICAgIC8vIGl0IGNhbiBoYXBwZW4gdGhhdCB0aGUgdXNlciBoYXMgY29uZmlndXJlZCBzb21ldGhpbmcgd3JvbmcsXG4gICAgLy8gaS5FLiBhbiBlbXB0eSBlbWFpbF9mcm9tLiBpbiB0aGF0IGNhc2UganVzdCBpZ25vcmUgLi4uXG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICAvLyBhZG1pbiBlbWFpbCBsb2NhbGl6ZWQgZnJvbSBiYWNrZW5kLCBhIGJpdCB1Z2x5XG4gICAgICAvLyB0b2RvIGFzayBmb3IgYW4gZW5kcG9pbnQgdG8gcHJvY2VzcyB0aG9zZSBzcGVjaWFsIG1lcmdlIHRhZ3NcbiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS93cG5pbmphcy9uaW5qYS1mb3Jtcy12aWRlb21haWwvaXNzdWVzLzMwXG4gICAgICBpZiAodmFsdWUgPT09ICd7d3A6YWRtaW5fZW1haWx9Jykge1xuICAgICAgICB2YWx1ZSA9IHdpbmRvdy5uZlZpZGVvbWFpbC5hZG1pbl9lbWFpbFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIHJhd0ZpZWxkS2V5ID0gdmFsdWUucmVwbGFjZSgne2ZpZWxkOicsICcnKS5yZXBsYWNlKCd9JywgJycpXG5cbiAgICAgICAgaWYgKHJhd0ZpZWxkS2V5ICE9PSB2YWx1ZSkge1xuICAgICAgICAgIC8vIHllcyBpdCB3YXMgYSBtZXJnZSB0YWcsIHNvIHVzZSBpdFxuICAgICAgICAgIHZhbHVlID0gZm9ybVZhbHVlc1tyYXdGaWVsZEtleV1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZVxuICB9LFxuXG4gIGdldEZvcm1WYWx1ZXM6IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgZm9ybU1vZGVsID0gQmFja2JvbmUuUmFkaW8uY2hhbm5lbCgnYXBwJykucmVxdWVzdCgnZ2V0OmZvcm0nLCB0aGlzLmdldEZvcm1JZCgpKVxuICAgIHZhciBmaWVsZHNDb2xsZWN0aW9uID0gZm9ybU1vZGVsLmdldCgnZmllbGRzJylcblxuICAgIHJldHVybiBmaWVsZHNDb2xsZWN0aW9uLnJlZHVjZShmdW5jdGlvbiAobWVtbywgZmllbGQpIHtcbiAgICAgIG1lbW9bZmllbGQuZ2V0KCdrZXknKV0gPSBmaWVsZC5nZXQoJ3ZhbHVlJylcbiAgICAgIHJldHVybiBtZW1vXG4gICAgfSwge30pXG4gIH0sXG5cbiAgYWRqdXN0Rm9ybURhdGFCZWZvcmVQb3N0aW5nVG9WaWRlb21haWxTZXJ2ZXI6IGZ1bmN0aW9uICh2aWRlb21haWwsIGNiKSB7XG4gICAgdmFyIGZvcm1WYWx1ZXMgPSB0aGlzLmdldEZvcm1WYWx1ZXMoKVxuXG4gICAgdmlkZW9tYWlsLmZyb20gPSB0aGlzLmdldE1lcmdlVGFnVmFsdWUoJ2VtYWlsX2Zyb20nLCBmb3JtVmFsdWVzKVxuICAgIHZpZGVvbWFpbC50byA9IHRoaXMuZ2V0TWVyZ2VUYWdWYWx1ZSgnZW1haWxfdG8nLCBmb3JtVmFsdWVzKVxuICAgIHZpZGVvbWFpbC5zdWJqZWN0ID0gdGhpcy5nZXRNZXJnZVRhZ1ZhbHVlKCdlbWFpbF9zdWJqZWN0JywgZm9ybVZhbHVlcylcbiAgICB2aWRlb21haWwuYm9keSA9IHRoaXMuZ2V0TWVyZ2VUYWdWYWx1ZSgnZW1haWxfYm9keScsIGZvcm1WYWx1ZXMpXG5cbiAgICBjYihudWxsLCB2aWRlb21haWwpXG4gIH0sXG5cbiAgb25CZWZvcmVEZXN0cm95OiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy52aWRlb21haWxDbGllbnQudW5sb2FkKClcbiAgICBkZWxldGUgdGhpcy52aWRlb21haWxDbGllbnRcbiAgfVxufSlcblxualF1ZXJ5KGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoKSB7XG4gIHJldHVybiBuZXcgVmlkZW9tYWlsRmllbGRDb250cm9sbGVyKClcbn0pXG4iXX0=
